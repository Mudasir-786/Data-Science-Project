<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Advanced AQI Dashboard - Ultra Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes successPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #4facfe);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 0.6s ease;
        }
        
        header {
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            animation: slideUp 0.8s ease;
            backdrop-filter: blur(10px);
        }
        
        header h1 {
            font-size: 3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .emoji-float {
            display: inline-block;
            animation: float 3s ease-in-out infinite;
            font-size: 1.2em;
        }
        
        nav {
            margin-top: 20px;
        }
        
        nav a {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            padding: 10px 25px;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-weight: 600;
            display: inline-block;
        }
        
        nav a:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .search-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            animation: slideUp 0.8s ease 0.2s backwards;
            backdrop-filter: blur(10px);
        }
        
        .search-box {
            display: flex;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 18px 25px;
            font-size: 1.1em;
            border: 3px solid #e0e0e0;
            border-radius: 50px;
            outline: none;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }
        
        input[type="text"]:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }
        
        button {
            padding: 18px 40px;
            font-size: 1.1em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        
        /* Language selector styling */
        #languageSelectorMain {
            transition: all 0.3s ease;
        }
        
        #languageSelectorMain:hover {
            border-color: #764ba2;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }
        
        #languageSelectorMain:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }
        
        .results {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            animation: slideUp 0.8s ease 0.4s backwards;
            backdrop-filter: blur(10px);
        }
        
        .aqi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 50px;
            border-radius: 25px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .aqi-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .aqi-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 30px 80px rgba(102, 126, 234, 0.6);
        }
        
        .aqi-value {
            font-size: 5em;
            font-weight: 700;
            margin: 20px 0;
            text-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .aqi-category {
            font-size: 2em;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .card:hover::before {
            left: 100%;
        }
        
        .card:hover {
            transform: translateY(-15px) rotateX(5deg) rotateY(5deg);
            box-shadow: 0 25px 60px rgba(0,0,0,0.2);
        }
        
        .card h3 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .card-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #333;
            margin: 15px 0;
        }
        
        .card p {
            color: #666;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-top: 30px;
            animation: slideUp 0.8s ease 0.6s backwards;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .feature-card {
            background: white;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.05), transparent);
            transition: left 0.5s ease;
        }
        
        .feature-card:hover::before {
            left: 100%;
        }
        
        .feature-card:hover {
            transform: translateY(-15px) scale(1.03);
            box-shadow: 0 25px 60px rgba(0,0,0,0.2);
        }
        
        .feature-icon {
            font-size: 3.5em;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .feature-card h3 {
            color: #667eea;
            font-size: 1.4em;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .feature-card p {
            color: #666;
            line-height: 1.7;
            font-size: 1em;
        }
        
        .feature-card button {
            margin-top: 20px;
            padding: 12px 30px;
            font-size: 1em;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 40px;
            border-radius: 25px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            animation: successPop 0.5s ease;
            box-shadow: 0 30px 90px rgba(0,0,0,0.4);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close:hover {
            color: #667eea;
        }
        
        .health-category {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            margin: 15px 0;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .health-category:hover {
            transform: translateX(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* NEW STYLES FOR ADVANCED FEATURES */
        .language-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .language-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .chat-message {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            animation: slideIn 0.3s ease;
        }

        .bot-message {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .user-message {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            text-align: right;
        }

        .quick-chat-btn {
            background: #f38181;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .quick-chat-btn:hover {
            background: #d63447;
            transform: scale(1.05);
        }

        .app-download-btn {
            display: inline-block;
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .app-download-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            font-size: 1.2em;
            color: #667eea;
        }
        
        .error {
            background: #ffe0e0;
            color: #d8000c;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #d8000c;
            animation: slideUp 0.5s ease;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #28a745;
            animation: successPop 0.6s ease;
        }
        
        /* ========== DARK MODE & ALL NEW FEATURES ========== */
        body.dark-mode { background: linear-gradient(-45deg, #1a1a2e, #16213e, #0f3460, #533483); color: #e0e0e0; }
        body.dark-mode header, body.dark-mode .search-section, body.dark-mode .results, body.dark-mode .card, body.dark-mode .feature-card, body.dark-mode .chart-container, body.dark-mode .modal-content { background: rgba(30, 30, 46, 0.95); color: #e0e0e0; }
        body.dark-mode h2, body.dark-mode h3, body.dark-mode .card h3, body.dark-mode .feature-card h3 { color: #8b9aed; }
        body.dark-mode p, body.dark-mode .card p { color: #b0b0b0; }
        body.dark-mode input[type="text"] { background: rgba(50, 50, 70, 0.8); color: #e0e0e0; border-color: #555; }
        body.dark-mode input[type="text"]:focus { border-color: #8b9aed; }
        body.dark-mode .health-category { background: rgba(50, 50, 70, 0.6); }
        .theme-toggle { position: fixed; top: 20px; right: 20px; z-index: 1000; background: rgba(102, 126, 234, 0.9); color: white; border: none; padding: 12px 18px; border-radius: 50px; cursor: pointer; font-size: 1.2em; box-shadow: 0 5px 20px rgba(0,0,0,0.3); transition: all 0.3s ease; }
        .theme-toggle:hover { transform: scale(1.1) rotate(15deg); box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5); }
        body.dark-mode .theme-toggle { background: rgba(139, 154, 237, 0.9); }
        .favorite-btn { background: none; border: none; font-size: 1.3em; cursor: pointer; transition: transform 0.3s ease; padding: 5px; margin-left: 10px; }
        .favorite-btn:hover { transform: scale(1.3); }
        .favorite-btn.active { color: #ffd700; animation: pulse 1s infinite; }
        .favorites-bar { background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; animation: slideUp 0.6s ease; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        body.dark-mode .favorites-bar { background: rgba(30, 30, 46, 0.95); }
        body.dark-mode .favorites-bar h3 { color: #8b9aed; }
        body.dark-mode #favorite-input { background: rgba(50, 50, 70, 0.8); color: #e0e0e0; border-color: #667eea; }
        body.dark-mode #favorite-input::placeholder { color: #999; }
        .favorite-chip { display: inline-block; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 15px; border-radius: 20px; margin: 5px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; }
        .favorite-chip:hover { transform: translateY(-2px); box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4); }
        .favorite-chip .remove { margin-left: 8px; cursor: pointer; font-weight: bold; }
        .share-buttons { margin: 20px 0; text-align: center; }
        .share-btn { display: inline-block; padding: 10px 20px; margin: 5px; border-radius: 25px; color: white; text-decoration: none; font-weight: 600; transition: all 0.3s ease; font-size: 0.9em; }
        .share-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .share-twitter { background: #1DA1F2; }
        .share-whatsapp { background: #25D366; }
        .share-facebook { background: #4267B2; }
        
        /* ========== PRINT STYLES ========== */
        @media print { 
            body { 
                background: white !important; 
                color: black !important;
            }
            .theme-toggle, 
            nav, 
            .favorite-btn, 
            button:not(.no-print), 
            .feature-card, 
            .share-buttons,
            .favorites-bar,
            .search-section,
            form { 
                display: none !important; 
            }
            .results, .aqi-card, .card, .chart-container {
                page-break-inside: avoid;
                box-shadow: none !important;
            }
            header {
                background: white !important;
                color: black !important;
            }
        }
        
        @media (max-width: 768px) {
            header h1 { font-size: 2em; }
            .aqi-value { font-size: 3.5em; }
            .grid { grid-template-columns: 1fr; }
            nav a { display: block; margin: 10px 0; }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">🌙</button>
    
    <div class="container">
        <!-- Favorites Management Bar -->
        <div id="favorites-bar" class="favorites-bar" style="display: block;">
            <h3 style="margin: 0 0 15px 0;">⭐ Manage Your Favorite Cities</h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Add cities manually or click ⭐ after searching. Your favorites are saved locally.</p>
            
            <!-- Add Favorite Input -->
            <div style="margin-bottom: 15px;">
                <input type="text" 
                       id="favorite-input" 
                       placeholder="Type city name (e.g., London, Paris, Tokyo)..." 
                       style="padding: 10px 15px; border-radius: 20px; border: 2px solid #667eea; width: 300px; font-size: 14px; margin-right: 10px;"
                       onkeypress="if(event.key==='Enter') addFavoriteFromInput()">
                <button onclick="addFavoriteFromInput()" 
                        style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    ➕ Add
                </button>
                <button onclick="clearAllFavorites()" 
                        style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; margin-left: 5px;">
                    �️ Clear All
                </button>
            </div>
            
            <!-- Favorites List -->
            <div id="favorites-list" style="margin-top: 10px;">
                <p style="color: #999; font-style: italic;">No favorites yet. Add cities above or search and click ⭐</p>
            </div>
        </div>
        
        <header>
            <h1><span class="emoji-float"></span> Advanced AQI Dashboard <span class="emoji-float"></span></h1>
            <p style="font-size: 1.2em; color: #666; margin-top: 10px; font-weight: 400;">Real-time Air Quality Monitoring with ML-Powered Predictions</p>
            <nav>
                <a href="/"> 🏠 Home</a>
                <a href="/compare"> 📊 Compare Cities</a>
                <a href="/history"> 📜 History</a>
                <a href="/rankings"> 🏆 Rankings</a>
            </nav>
        </header>

        <div class="search-section">
            <h2 style="text-align: center; color: #667eea; margin-bottom: 25px; font-size: 2em;">🔍 Search Any City</h2>
            
            <!-- NOTIFICATION TEST BUTTON - WORKING VERSION -->
            <div style="text-align: center; margin: 20px auto; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; max-width: 600px; box-shadow: 0 10px 30px rgba(102,126,234,0.4);">
                <h3 style="color: white; margin-bottom: 15px; font-size: 1.3em;">🔔 Test Real-Time Notifications</h3>
                
                <button id="testNotifBtn" style="
                    padding: 15px 40px;
                    font-size: 1.2em;
                    background: white;
                    color: #667eea;
                    border: none;
                    border-radius: 30px;
                    cursor: pointer;
                    font-weight: 700;
                    font-family: 'Poppins', sans-serif;
                    box-shadow: 0 5px 20px rgba(255,255,255,0.3);
                    transition: all 0.3s ease;
                ">
                    🔔 Click to Test Notification!
                </button>
                
                <div id="testStatus" style="margin-top: 15px; padding: 12px; border-radius: 10px; color: white; font-weight: 600; display: none;"></div>
                
                <p style="margin-top: 12px; color: rgba(255,255,255,0.9); font-size: 0.95em;">
                    ✨ Test if notifications work on your device • Will show a popup in top-right corner
                </p>
            </div>
            
            <script>
            // Inline test function to avoid conflicts
            document.getElementById('testNotifBtn').addEventListener('click', function() {
                const btn = this;
                const status = document.getElementById('testStatus');
                status.style.display = 'block';
                
                console.log('🔔 Test button clicked!');
                
                // Check browser support
                if (!('Notification' in window)) {
                    status.style.background = '#dc3545';
                    status.innerHTML = '❌ Your browser does not support notifications';
                    console.error('Browser does not support notifications');
                    return;
                }
                
                console.log('✅ Browser supports notifications');
                console.log('Current permission:', Notification.permission);
                
                // Function to send test notification
                function sendTestNotif() {
                    try {
                        console.log('� Sending test notification...');
                        const notif1 = new Notification('🎉 Test Successful!', {
                            body: 'Notifications are working perfectly! Check top-right corner.',
                            icon: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
                            badge: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png'
                        });
                        
                        status.style.background = '#28a745';
                        status.innerHTML = '✅ Notification sent! Check TOP-RIGHT corner of your screen 👆';
                        
                        console.log('✅ Test notification created:', notif1);
                        
                        // Send second notification after 2 seconds
                        setTimeout(() => {
                            console.log('🚀 Sending AQI test notification...');
                            const notif2 = new Notification('⚠️ Air Quality Alert!', {
                                body: 'AQI in Test City is 75. This is how real alerts look!',
                                icon: 'https://cdn-icons-png.flaticon.com/512/1163/1163624.png'
                            });
                            console.log('✅ AQI test notification created:', notif2);
                        }, 2000);
                        
                        // Save to localStorage
                        localStorage.setItem('notifications_enabled', 'true');
                        console.log('✅ Saved to localStorage');
                        
                    } catch (error) {
                        console.error('❌ Error creating notification:', error);
                        status.style.background = '#dc3545';
                        status.innerHTML = '❌ Error: ' + error.message;
                    }
                }
                
                // Check permission and act accordingly
                if (Notification.permission === 'granted') {
                    console.log('✅ Permission already granted');
                    sendTestNotif();
                    
                } else if (Notification.permission === 'denied') {
                    console.log('❌ Permission denied');
                    status.style.background = '#dc3545';
                    status.innerHTML = '❌ Blocked! Enable in: Chrome Settings → Privacy → Notifications → Allow';
                    
                } else {
                    console.log('⏳ Requesting permission...');
                    status.style.background = '#ffc107';
                    status.innerHTML = '⏳ Click ALLOW in the browser popup! 👆';
                    
                    Notification.requestPermission().then(function(permission) {
                        console.log('Permission result:', permission);
                        
                        if (permission === 'granted') {
                            console.log('✅ Permission granted!');
                            sendTestNotif();
                        } else {
                            console.log('❌ Permission denied');
                            status.style.background = '#dc3545';
                            status.innerHTML = '❌ You clicked Block. Refresh page and try again.';
                        }
                    }).catch(function(error) {
                        console.error('Error requesting permission:', error);
                        status.style.background = '#dc3545';
                        status.innerHTML = '❌ Error: ' + error.message;
                    });
                }
            });
            </script>
            
            <!-- Language Selector Row -->
            <div style="text-align: center; margin-bottom: 20px;">
                <label style="font-size: 1.1em; font-weight: 600; color: #667eea; margin-right: 10px;">🌐 Select Language:</label>
                <select id="languageSelectorMain" onchange="changeLanguageQuick(this.value)" style="
                    padding: 10px 20px;
                    font-size: 1em;
                    border: 2px solid #667eea;
                    border-radius: 25px;
                    background: white;
                    color: #667eea;
                    cursor: pointer;
                    font-weight: 600;
                    font-family: 'Poppins', sans-serif;
                    outline: none;
                    transition: all 0.3s ease;
                ">
                    <option value="en">English 🇬🇧</option>
                    <option value="ur">اردو 🇵🇰 (Urdu)</option>
                    <option value="hi">हिंदी 🇮🇳 (Hindi)</option>
                    <option value="ar">العربية 🇸🇦 (Arabic)</option>
                    <option value="es">Español 🇪🇸 (Spanish)</option>
                    <option value="fr">Français 🇫🇷 (French)</option>
                    <option value="de">Deutsch 🇩🇪 (German)</option>
                    <option value="zh">中文 🇨🇳 (Chinese)</option>
                </select>
                <span id="langStatus" style="margin-left: 15px; color: #28a745; font-weight: 600;"></span>
            </div>
            
            <div style="text-align: center; margin-bottom: 15px;">
                <button onclick="useMyLocation()" style="padding: 12px 25px; background: #28a745; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 15px; font-weight: 600; font-family: 'Poppins';">
                    📍 Use My Location
                </button>
            </div>
            <form method="POST" action="/" id="aqi-form">
                <div class="search-box" style="position: relative;">
                    <input type="text" name="city" id="cityInput" placeholder="🔍 Start typing city name (e.g., Del for Delhi, Lon for London)..." required autocomplete="off">
                    <div id="suggestions" style="
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 80px;
                        background: white;
                        border: 2px solid #667eea;
                        border-top: none;
                        border-radius: 0 0 20px 20px;
                        max-height: 300px;
                        overflow-y: auto;
                        display: none;
                        z-index: 1000;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    "></div>
                    <button type="submit">🔎 Get AQI Data</button>
                </div>
            </form>
        </div>

        {% if aqi_data %}
        <div class="results">
            <div class="aqi-card">
                <h2>{{ aqi_data.city_display|title if aqi_data.city_display else city|title }}
                    {% if aqi_data.country %}
                    <span style="font-size: 0.7em; color: #667eea; font-weight: normal;">🌍 {{ aqi_data.country }}</span>
                    {% endif %}
                    <button class="favorite-btn" onclick="addToFavorites('{{ aqi_data.city_display|title if aqi_data.city_display else city|title }}')" title="Add to favorites">⭐</button>
                </h2>
                <div class="aqi-value" id="aqiValue">0</div>
                <div class="aqi-category">{{ aqi_data.category }}</div>
                <p style="font-size: 1.2em; margin-top: 15px;">{{ aqi_data.recommendation }}</p>
                
                <!-- Hidden data for notification trigger -->
                <script>
                    // Immediately trigger notification when AQI results load
                    (function() {
                        const aqiValue = {{ aqi_data.aqi }};
                        const cityName = '{{ aqi_data.city_display|title if aqi_data.city_display else city|title }}';
                        console.log('🔔 Triggering notification check - AQI:', aqiValue, 'City:', cityName);
                        
                        // Small delay to ensure function is available
                        setTimeout(function() {
                            if (typeof checkAQINotification === 'function') {
                                checkAQINotification(aqiValue, cityName);
                                console.log('✅ Notification function called successfully');
                            } else {
                                console.error('❌ checkAQINotification function not found!');
                            }
                        }, 500);
                    })();
                </script>
                
                <!-- Social Sharing Buttons -->
                <div class="share-buttons">
                    <a href="javascript:void(0)" class="share-btn share-twitter" onclick="shareToTwitter('{{ aqi_data.city_display|title if aqi_data.city_display else city|title }}', {{ aqi_data.aqi }}, '{{ aqi_data.country }}')">
                        🐦 Share on Twitter
                    </a>
                    <a href="javascript:void(0)" class="share-btn share-whatsapp" onclick="shareToWhatsApp('{{ aqi_data.city_display|title if aqi_data.city_display else city|title }}', {{ aqi_data.aqi }}, '{{ aqi_data.country }}')">
                        💬 Share on WhatsApp
                    </a>
                    <a href="javascript:void(0)" class="share-btn share-facebook" onclick="shareToFacebook('{{ aqi_data.city_display|title if aqi_data.city_display else city|title }}', {{ aqi_data.aqi }}, '{{ aqi_data.country }}')">
                        👍 Share on Facebook
                    </a>
                </div>
            </div>

            <h2 style="text-align: center; color: #667eea; margin-bottom: 25px; font-size: 2em;"> Pollutant Details</h2>
            <div class="grid">
                {% for pollutant, data in pollutants_data.items() %}
                <div class="card">
                    <h3>{{ data.icon }} {{ pollutant }}</h3>
                    <div class="card-value" data-target="{{ data.value }}">0</div>
                    <p>{{ data.unit }}</p>
                    <p style="margin-top: 10px; font-weight: 500;">{{ data.name }}</p>
                </div>
                {% endfor %}
            </div>

            <div class="chart-container">
                <h2 style="text-align: center; color: #667eea; margin-bottom: 15px; font-size: 2em;"> 48-Hour AQI Forecast</h2>
                
                <!-- Location Info with Google Maps -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; color: white; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                        <div style="flex: 1; min-width: 250px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 1.3em;">📍 Location Details</h3>
                            <p style="margin: 5px 0; font-size: 1.1em;">
                                <strong style="font-size: 1.3em;">City:</strong> 
                                <span style="font-size: 1.3em;">{{ aqi_data.city_display|title if aqi_data.city_display else city|title }}</span>
                            </p>
                            <p style="margin: 5px 0; font-size: 1.2em;">
                                <strong style="font-size: 1.4em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Country:</strong> 
                                <span style="font-size: 1.4em; font-weight: 900; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">🌍 {{ aqi_data.country if aqi_data.country else 'Unknown' }}</span>
                            </p>
                        </div>
                        <div style="flex: 1; min-width: 250px;">
                            {% if aqi_data.city_display %}
                            <a href="https://www.google.com/maps/search/?api=1&query={{ aqi_data.city_display|urlencode }}+{{ aqi_data.country|urlencode }}" 
                               target="_blank" 
                               style="display: inline-block; background: white; color: #667eea; padding: 12px 25px; border-radius: 30px; text-decoration: none; font-weight: bold; font-size: 1.1em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease;"
                               onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)';"
                               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';">
                                🗺️ View on Google Maps
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <canvas id="aqiChart"></canvas>
            </div>
        </div>
        {% endif %}

        <div class="search-section">
            <h2 style="text-align: center; color: #667eea; margin-bottom: 25px; font-size: 2em;">⚡ Powerful Features</h2>
            <div class="features-grid">
                <!-- NEW DATA SCIENCE FEATURES -->
                <div class="feature-card" onclick="window.location.href='/forecast'" style="border: 3px solid #ff6b6b;">
                    <div class="feature-icon">📊</div>
                    <h3>🔮 AQI Forecast</h3>
                    <p>ML-based 7-day air quality prediction using historical data</p>
                    <button type="button" style="background: #ff6b6b;">Predict Future</button>
                </div>

                <div class="feature-card" onclick="window.location.href='/heatmap'" style="border: 3px solid #00e400;">
                    <div class="feature-icon">🗺️</div>
                    <h3>🌍 Interactive Heatmap</h3>
                    <p>Geographic visualization of AQI across multiple cities</p>
                    <button type="button" style="background: #00e400;">View Map</button>
                </div>

                <div class="feature-card" onclick="window.location.href='/analytics'" style="border: 3px solid #ffaa00;">
                    <div class="feature-icon">📈</div>
                    <h3>📊 Analytics Dashboard</h3>
                    <p>Advanced statistical analysis with correlations & trends</p>
                    <button type="button" style="background: #ffaa00;">Analyze Data</button>
                </div>

                <div class="feature-card" onclick="window.location.href='/calculator'" style="border: 3px solid #9b59b6;">
                    <div class="feature-icon">🌍</div>
                    <h3>🧮 AQI Calculator</h3>
                    <p>Calculate AQI from pollutant concentrations (EPA formula)</p>
                    <button type="button" style="background: #9b59b6;">Calculate Now</button>
                </div>

                <div class="feature-card" onclick="window.location.href='/compare-advanced'" style="border: 3px solid #e74c3c;">
                    <div class="feature-icon">📱</div>
                    <h3>🔬 Multi-City Statistics</h3>
                    <p>Compare 5 cities with T-test, ANOVA & correlation analysis</p>
                    <button type="button" style="background: #e74c3c;">Statistical Compare</button>
                </div>

                <div class="feature-card" onclick="testAPI()">
                    <div class="feature-icon">🔌</div>
                    <h3>Test API Connection</h3>
                    <p>Verify real-time data fetching from OpenWeatherMap Air Pollution API</p>
                    <button type="button">Test Now</button>
                </div>

                <!-- Compare, History, Rankings cards removed temporarily for stability -->

                <div class="feature-card" onclick="window.location.href='/download/csv'">
                    <div class="feature-icon">📥</div>
                    <h3>Download CSV</h3>
                    <p>Export all historical data in CSV format for analysis</p>
                    <button type="button">Download CSV</button>
                </div>

                <div class="feature-card" onclick="window.location.href='/download/json'">
                    <div class="feature-icon">📋</div>
                    <h3>Download JSON</h3>
                    <p>Export data in JSON format for integration</p>
                    <button type="button">Download JSON</button>
                </div>

                <div class="feature-card" onclick="showHealthGuide()">
                    <div class="feature-icon">📚</div>
                    <h3>Health Guide</h3>
                    <p>Learn about AQI categories and health recommendations</p>
                    <button type="button">Learn More</button>
                </div>

                <!-- TEST FEATURES PAGE -->
                <div class="feature-card" onclick="window.location.href='/test-features'" style="border: 3px solid #28a745;">
                    <div class="feature-icon">🧪</div>
                    <h3>🔧 Test New Features</h3>
                    <p>Test dark mode, favorites, notifications, sharing & export features</p>
                    <button type="button" style="background: #28a745;">Test Features</button>
                </div>

                <!-- NEW ADVANCED FEATURES -->
                <div class="feature-card" onclick="toggleNotifications()" style="border: 3px solid #ff6b6b;">
                    <div class="feature-icon">🔔</div>
                    <h3>Real-Time Notifications</h3>
                    <p>Get browser alerts when AQI crosses unhealthy levels</p>
                    <button type="button" style="background: #ff6b6b;">Enable Alerts</button>
                </div>

                <div class="feature-card" onclick="toggleLanguage()" style="border: 3px solid #4ecdc4;">
                    <div class="feature-icon">🌐</div>
                    <h3>Multi-Language Support</h3>
                    <p>Switch between English, Urdu, Hindi & more languages</p>
                    <button type="button" style="background: #4ecdc4;">Change Language</button>
                </div>

                <div class="feature-card" onclick="showAirQualityMap()" style="border: 3px solid #95e1d3;">
                    <div class="feature-icon">🗺️</div>
                    <h3>Air Quality Map</h3>
                    <p>Interactive world map with real-time AQI data visualization</p>
                    <button type="button" style="background: #95e1d3;">View Map</button>
                </div>

                <div class="feature-card" onclick="openChatbot()" style="border: 3px solid #f38181;">
                    <div class="feature-icon">💬</div>
                    <h3>AI Chatbot Assistant</h3>
                    <p>Ask questions about air quality, health tips & recommendations</p>
                    <button type="button" style="background: #f38181;">Chat Now</button>
                </div>

                <div class="feature-card" onclick="showMobileApp()" style="border: 3px solid #a8e6cf;">
                    <div class="feature-icon">📱</div>
                    <h3>Mobile App Download</h3>
                    <p>Get our mobile app for Android & iOS with offline support</p>
                    <button type="button" style="background: #a8e6cf;">Download App</button>
                </div>
            </div>
        </div>

    <!-- NOTIFICATIONS MODAL -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNotificationsModal()">&times;</span>
            <h2 style="color: #ff6b6b; text-align: center;">🔔 Real-Time Notifications</h2>
            <div style="padding: 20px;">
                <p style="font-size: 1.2em; margin-bottom: 20px;">Enable browser notifications to get alerts when:</p>
                <ul style="font-size: 1.1em; line-height: 2;">
                    <li>✅ AQI exceeds 100 (Unhealthy for sensitive groups)</li>
                    <li>✅ AQI exceeds 150 (Unhealthy)</li>
                    <li>✅ AQI exceeds 200 (Very Unhealthy)</li>
                    <li>✅ Daily air quality updates for favorite cities</li>
                </ul>
                <div style="margin-top: 30px; text-align: center;">
                    <button onclick="requestNotificationPermission()" style="background: #ff6b6b; color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.2em; cursor: pointer; box-shadow: 0 4px 15px rgba(255,107,107,0.3);">
                        🔔 Enable Notifications
                    </button>
                    <p id="notificationStatus" style="margin-top: 15px; font-size: 1.1em; color: #666;"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- LANGUAGE MODAL -->
    <div id="languageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLanguageModal()">&times;</span>
            <h2 style="color: #4ecdc4; text-align: center;">🌐 Choose Your Language</h2>
            <div style="padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <button onclick="changeLanguage('en')" class="language-btn">🇬🇧 English</button>
                <button onclick="changeLanguage('ur')" class="language-btn">🇵🇰 اردو (Urdu)</button>
                <button onclick="changeLanguage('hi')" class="language-btn">🇮🇳 हिंदी (Hindi)</button>
                <button onclick="changeLanguage('ar')" class="language-btn">🇸🇦 العربية (Arabic)</button>
                <button onclick="changeLanguage('es')" class="language-btn">🇪🇸 Español</button>
                <button onclick="changeLanguage('fr')" class="language-btn">🇫🇷 Français</button>
                <button onclick="changeLanguage('de')" class="language-btn">🇩🇪 Deutsch</button>
                <button onclick="changeLanguage('zh')" class="language-btn">🇨🇳 中文 (Chinese)</button>
            </div>
            <p id="currentLanguage" style="text-align: center; margin-top: 20px; font-size: 1.2em; color: #4ecdc4;">Current: English 🇬🇧</p>
        </div>
    </div>

    <!-- AIR QUALITY MAP MODAL -->
    <div id="mapModal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 1200px;">
            <span class="close" onclick="closeMapModal()">&times;</span>
            <h2 style="color: #95e1d3; text-align: center;">🗺️ Global Air Quality Map</h2>
            <div style="padding: 20px;">
                <iframe src="https://aqicn.org/map/world/" 
                        style="width: 100%; height: 600px; border: 2px solid #95e1d3; border-radius: 15px;" 
                        title="World Air Quality Map">
                </iframe>
                <p style="text-align: center; margin-top: 15px; color: #666;">Powered by World Air Quality Index Project</p>
            </div>
        </div>
    </div>

    <!-- CHATBOT MODAL -->
    <div id="chatbotModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChatbotModal()">&times;</span>
            <h2 style="color: #f38181; text-align: center;">💬 AI Chatbot Assistant</h2>
            <div id="chatMessages" style="height: 400px; overflow-y: auto; padding: 20px; background: #f8f9fa; border-radius: 10px; margin-bottom: 20px;">
                <div class="chat-message bot-message">
                    <strong>🤖 AQI Bot:</strong> Hello! I'm your intelligent Air Quality assistant powered by AI! 🌍
                    <br><br>
                    I can answer <strong>50+ different questions</strong> about:
                    <ul style="margin-top: 10px; line-height: 1.8;">
                        <li>📊 <strong>AQI Basics:</strong> What is AQI, calculations, scales</li>
                        <li>🌫️ <strong>Pollutants:</strong> PM2.5, PM10, CO, NO2, SO2, Ozone</li>
                        <li>🏥 <strong>Health Effects:</strong> Children, elderly, pregnant, asthma</li>
                        <li>🏃 <strong>Activities:</strong> Exercise, cycling, walking safety</li>
                        <li>🏠 <strong>Indoor Air:</strong> Purifiers, plants, ventilation</li>
                        <li>😷 <strong>Protection:</strong> Masks, prevention, safety tips</li>
                        <li>🌍 <strong>Locations:</strong> City-specific info (Delhi, Pakistan, China)</li>
                        <li>❄️ <strong>Weather:</strong> Seasonal effects, rain, wind impact</li>
                    </ul>
                    <br>
                    💡 <strong>Try asking:</strong> "What is PM2.5?", "Safe to exercise?", "Best air purifier?", "Masks for pollution"
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="chatInput" placeholder="Ask me about air quality..." style="flex: 1; padding: 12px; border: 2px solid #f38181; border-radius: 10px; font-size: 1em;">
                <button onclick="sendChatMessage()" style="background: #f38181; color: white; padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-size: 1em;">Send</button>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="quickChat('What is AQI?')" class="quick-chat-btn">What is AQI?</button>
                <button onclick="quickChat('What is PM2.5?')" class="quick-chat-btn">PM2.5?</button>
                <button onclick="quickChat('Is it safe to exercise?')" class="quick-chat-btn">Safe to exercise?</button>
                <button onclick="quickChat('Health tips')" class="quick-chat-btn">Health tips</button>
                <button onclick="quickChat('How to protect myself?')" class="quick-chat-btn">Protection</button>
                <button onclick="quickChat('Best air purifier?')" class="quick-chat-btn">Air Purifier</button>
                <button onclick="quickChat('Safe for children?')" class="quick-chat-btn">For Kids</button>
                <button onclick="quickChat('Masks for pollution')" class="quick-chat-btn">Masks</button>
                <button onclick="quickChat('Indoor air quality tips')" class="quick-chat-btn">Indoor Tips</button>
                <button onclick="quickChat('Why pollution in winter?')" class="quick-chat-btn">Winter Pollution</button>
            </div>
        </div>
    </div>

    <!-- MOBILE APP MODAL -->
    <div id="mobileAppModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMobileAppModal()">&times;</span>
            <h2 style="color: #a8e6cf; text-align: center;">📱 Download Mobile App</h2>
            <div style="padding: 30px; text-align: center;">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23a8e6cf' width='200' height='200' rx='20'/%3E%3Ctext x='50%25' y='50%25' font-size='80' text-anchor='middle' dy='.3em'%3E📱%3C/text%3E%3C/svg%3E" alt="App Icon" style="width: 150px; margin-bottom: 20px;">
                <h3 style="color: #a8e6cf; margin-bottom: 15px;">AQI Monitor - Your Air Quality Companion</h3>
                <p style="font-size: 1.1em; margin-bottom: 30px;">Get real-time air quality updates on your mobile device!</p>
                
                <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 30px;">
                    <a href="#" class="app-download-btn" style="background: #000;">
                        <span style="font-size: 2em;">🍎</span><br>
                        <span style="font-size: 0.9em;">Download on</span><br>
                        <strong style="font-size: 1.2em;">App Store</strong>
                    </a>
                    <a href="#" class="app-download-btn" style="background: #3ddc84;">
                        <span style="font-size: 2em;">🤖</span><br>
                        <span style="font-size: 0.9em;">Get it on</span><br>
                        <strong style="font-size: 1.2em;">Google Play</strong>
                    </a>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                    <h4 style="color: #666; margin-bottom: 15px;">✨ Features:</h4>
                    <ul style="text-align: left; display: inline-block; font-size: 1.1em; line-height: 2;">
                        <li>📊 Real-time AQI updates</li>
                        <li>🔔 Push notifications</li>
                        <li>📍 Location-based monitoring</li>
                        <li>🌓 Offline mode support</li>
                        <li>📈 Historical data tracking</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- MOBILE APP MODAL -->
    <div id="mobileAppModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMobileAppModal()">&times;</span>
            <h2 style="color: #a8e6cf; text-align: center;">📱 Download Mobile App</h2>
            <div style="padding: 30px; text-align: center;">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23a8e6cf' width='200' height='200' rx='20'/%3E%3Ctext x='50%25' y='50%25' font-size='80' text-anchor='middle' dy='.3em'%3E📱%3C/text%3E%3C/svg%3E" alt="App Icon" style="width: 150px; margin-bottom: 20px;">
                <h3 style="color: #a8e6cf; margin-bottom: 15px;">AQI Monitor - Your Air Quality Companion</h3>
                <p style="font-size: 1.1em; margin-bottom: 30px;">Get real-time air quality updates on your mobile device!</p>
                
                <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 30px;">
                    <a href="#" class="app-download-btn" style="background: #000;">
                        <span style="font-size: 2em;">🍎</span><br>
                        <span style="font-size: 0.9em;">Download on</span><br>
                        <strong style="font-size: 1.2em;">App Store</strong>
                    </a>
                    <a href="#" class="app-download-btn" style="background: #3ddc84;">
                        <span style="font-size: 2em;">🤖</span><br>
                        <span style="font-size: 0.9em;">Get it on</span><br>
                        <strong style="font-size: 1.2em;">Google Play</strong>
                    </a>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                    <h4 style="color: #666; margin-bottom: 15px;">✨ Features:</h4>
                    <ul style="text-align: left; display: inline-block; font-size: 1.1em; line-height: 2;">
                        <li>📊 Real-time AQI updates</li>
                        <li>🔔 Push notifications</li>
                        <li>📍 Location-based monitoring</li>
                        <li>🌓 Offline mode support</li>
                        <li>📈 Historical data tracking</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- HEALTH GUIDE MODAL -->
    <div id="healthModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 style="color: #667eea; text-align: center; margin-bottom: 30px; font-size: 2.2em;"> AQI Health Guide</h2>
            
            <div class="health-category" style="border-left-color: #00e400;">
                <h3 style="color: #00e400; font-size: 1.5em;">0-50: Good </h3>
                <p>Air quality is satisfactory, and air pollution poses little or no risk.</p>
            </div>
            
            <div class="health-category" style="border-left-color: #ffff00;">
                <h3 style="color: #e6b800; font-size: 1.5em;">51-100: Moderate </h3>
                <p>Air quality is acceptable. However, there may be a risk for some people, particularly those who are unusually sensitive to air pollution.</p>
            </div>
            
            <div class="health-category" style="border-left-color: #ff7e00;">
                <h3 style="color: #ff7e00; font-size: 1.5em;">101-150: Unhealthy for Sensitive Groups </h3>
                <p>Members of sensitive groups may experience health effects. The general public is less likely to be affected.</p>
            </div>
            
            <div class="health-category" style="border-left-color: #ff0000;">
                <h3 style="color: #ff0000; font-size: 1.5em;">151-200: Unhealthy </h3>
                <p>Some members of the general public may experience health effects; members of sensitive groups may experience more serious health effects.</p>
            </div>
            
            <div class="health-category" style="border-left-color: #8f3f97;">
                <h3 style="color: #8f3f97; font-size: 1.5em;">201-300: Very Unhealthy </h3>
                <p>Health alert: The risk of health effects is increased for everyone.</p>
            </div>
            
            <div class="health-category" style="border-left-color: #7e0023;">
                <h3 style="color: #7e0023; font-size: 1.5em;">301+: Hazardous </h3>
                <p>Health warning of emergency conditions: everyone is more likely to be affected.</p>
            </div>
        </div>
    </div>

    <script>
        // Animate counter numbers
        function animateValue(element, start, end, duration) {
            const range = end - start;
            const increment = range / 100;
            let current = start;
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = Math.round(current * 100) / 100;
            }, duration / 100);
        }

        // Sound effect
        function playSound(frequency = 800, duration = 100) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        // Animate all card values on page load
        document.addEventListener('DOMContentLoaded', function() {
            const aqiValue = document.getElementById('aqiValue');
            if (aqiValue) {
                const targetAQI = {{ aqi_data.aqi if aqi_data else 0 }};
                animateValue(aqiValue, 0, targetAQI, 2000);
            }

            document.querySelectorAll('.card-value').forEach(element => {
                const target = parseFloat(element.getAttribute('data-target'));
                animateValue(element, 0, target, 2000);
            });
        });

        // Test API function
        async function testAPI() {
            playSound(900, 150);
            
            // Get city from search input if available, otherwise use current city or random
            let testCity = document.querySelector('input[name="city"]')?.value || '{{ city if city else "" }}';
            
            if (!testCity || testCity.trim() === '') {
                // If no city searched yet, ask user or use random
                const cities = ['Delhi', 'London', 'Tokyo', 'New York', 'Beijing'];
                testCity = cities[Math.floor(Math.random() * cities.length)];
            }
            
            try {
                // Use new consistent endpoint that uses same logic as main search
                const response = await fetch(`/api/test-api/${encodeURIComponent(testCity)}`);
                
                const data = await response.json();
                if (data.success) {
                    playSound(1200, 200);
                    const location = data.country && data.country !== 'Unknown' ? `${data.city}, ${data.country}` : data.city;
                    alert(`✅ API Test Successful!\n\n📍 Location: ${location}\n🌍 Country: ${data.country}\n💨 AQI: ${data.aqi}\n🌫️ PM2.5: ${data.pm25} µg/m³\n📊 Category: ${data.category}\n\n✨ ${data.note}\n✅ Real-time data is working perfectly!`);
                } else {
                    alert('⚠️ No data received: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('❌ API test failed: ' + error.message);
            }
        }

        // Show health guide modal
        function showHealthGuide() {
            playSound(1000, 150);
            document.getElementById('healthModal').style.display = 'block';
        }

        // Close modal
        function closeModal() {
            playSound(800, 100);
            document.getElementById('healthModal').style.display = 'none';
        }

        // ========== NEW ADVANCED FEATURES FUNCTIONS ==========

        // NOTIFICATIONS
        function toggleNotifications() {
            playSound(900, 150);
            document.getElementById('notificationsModal').style.display = 'block';
        }

        function closeNotificationsModal() {
            document.getElementById('notificationsModal').style.display = 'none';
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    const status = document.getElementById('notificationStatus');
                    if (permission === 'granted') {
                        status.textContent = '✅ Notifications Enabled Successfully!';
                        status.style.color = '#28a745';
                        new Notification('🔔 AQI Monitor', {
                            body: 'You will now receive air quality alerts!',
                            icon: '🌍'
                        });
                        localStorage.setItem('notifications_enabled', 'true');
                    } else {
                        status.textContent = '❌ Notification permission denied';
                        status.style.color = '#dc3545';
                    }
                });
            } else {
                alert('Your browser does not support notifications');
            }
        }

        // Check AQI and send notification if needed
        function checkAQINotification(aqi, city) {
            console.log('🔔 checkAQINotification called with AQI:', aqi, 'City:', city);
            console.log('📋 Checking conditions:');
            console.log('  - notifications_enabled:', localStorage.getItem('notifications_enabled'));
            console.log('  - Notification support:', 'Notification' in window);
            console.log('  - Permission:', Notification.permission);
            
            if (localStorage.getItem('notifications_enabled') === 'true' && 'Notification' in window && Notification.permission === 'granted') {
                console.log('✅ All conditions passed!');
                // Production threshold: AQI > 150 (Unhealthy level)
                // For testing, lower to 50 if needed
                if (aqi > 150) {
                    console.log('🚀 Creating notification now...');
                    try {
                        const notification = new Notification(`⚠️ Unhealthy Air Quality Alert!`, {
                            body: `AQI in ${city} is ${aqi}. Stay indoors and avoid outdoor activities!`,
                            icon: '⚠️',
                            tag: 'aqi-alert',
                            requireInteraction: false
                        });
                        console.log('✅ Notification created successfully!', notification);
                    } catch (error) {
                        console.error('❌ Error creating notification:', error);
                    }
                } else {
                    console.log('ℹ️ AQI is safe:', aqi, '(threshold: 150 for alerts)');
                }
            } else {
                console.log('❌ Conditions not met for notification');
            }
        }

        // TEST NOTIFICATION FUNCTION - Quick test button
        function testNotificationNow() {
            const statusDiv = document.getElementById('notificationTestStatus');
            statusDiv.style.display = 'block';
            
            console.log('🧪 Starting notification test...');
            
            // Step 1: Check browser support
            if (!('Notification' in window)) {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = '❌ Your browser does not support notifications!';
                return;
            }
            
            console.log('✅ Browser supports notifications');
            
            // Step 2: Check permission
            console.log('Current permission:', Notification.permission);
            
            if (Notification.permission === 'granted') {
                // Already granted - send test notification
                console.log('✅ Permission already granted - sending test notification');
                try {
                    new Notification('🎉 Test Successful!', {
                        body: 'Notifications are working! Now enable from settings below and search any city.',
                        icon: '🔔',
                        requireInteraction: false
                    });
                    
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.innerHTML = '✅ Test notification sent! Check top-right corner of screen.';
                    
                    // Also test AQI notification
                    setTimeout(() => {
                        console.log('Testing AQI notification...');
                        new Notification('⚠️ Air Quality Alert!', {
                            body: 'AQI in Test City is 75. This is how real alerts will look!',
                            icon: '⚠️'
                        });
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error sending notification:', error);
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.innerHTML = '❌ Error: ' + error.message;
                }
            } else if (Notification.permission === 'denied') {
                // Permission denied
                console.log('❌ Permission denied');
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = '❌ Notifications blocked! Go to browser settings → Site settings → Notifications → Allow for this site';
            } else {
                // Need to request permission
                console.log('⚠️ Requesting permission...');
                statusDiv.style.background = '#d1ecf1';
                statusDiv.style.color = '#0c5460';
                statusDiv.innerHTML = '⏳ Requesting permission... Click ALLOW in the browser popup!';
                
                Notification.requestPermission().then(permission => {
                    console.log('Permission result:', permission);
                    
                    if (permission === 'granted') {
                        console.log('✅ Permission granted! Sending test notification...');
                        
                        // Send test notification
                        new Notification('🎉 Permission Granted!', {
                            body: 'Notifications are now enabled! You will receive air quality alerts.',
                            icon: '🔔'
                        });
                        
                        // Save to localStorage
                        localStorage.setItem('notifications_enabled', 'true');
                        
                        statusDiv.style.background = '#d4edda';
                        statusDiv.style.color = '#155724';
                        statusDiv.innerHTML = '✅ SUCCESS! Notification sent to top-right corner. Now search any city to get real alerts!';
                        
                        // Test AQI notification after 2 seconds
                        setTimeout(() => {
                            new Notification('⚠️ Air Quality Alert!', {
                                body: 'AQI in Test City is 75. This is how real alerts will look!',
                                icon: '⚠️'
                            });
                        }, 2000);
                        
                    } else {
                        statusDiv.style.background = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        statusDiv.innerHTML = '❌ Permission denied. Please enable notifications in browser settings.';
                    }
                });
            }
        }

        // LANGUAGE SUPPORT
        let currentLang = localStorage.getItem('language') || 'en';
        
        const translations = {
            en: { title: 'Advanced AQI Dashboard', search: 'Search City' },
            ur: { title: 'جدید اے کیو آئی ڈیش بورڈ', search: 'شہر تلاش کریں' },
            hi: { title: 'उन्नत एक्यूआई डैशबोर्ड', search: 'शहर खोजें' },
            ar: { title: 'لوحة معلومات جودة الهواء', search: 'بحث عن مدينة' },
            es: { title: 'Panel de Calidad del Aire', search: 'Buscar Ciudad' },
            fr: { title: 'Tableau de Bord Qualité Air', search: 'Rechercher Ville' },
            de: { title: 'Luftqualitäts-Dashboard', search: 'Stadt Suchen' },
            zh: { title: '空气质量仪表板', search: '搜索城市' }
        };

        function toggleLanguage() {
            playSound(900, 150);
            document.getElementById('languageModal').style.display = 'block';
        }

        function closeLanguageModal() {
            document.getElementById('languageModal').style.display = 'none';
        }

        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            
            const langNames = {
                en: 'English 🇬🇧', ur: 'اردو 🇵🇰', hi: 'हिंदी 🇮🇳', 
                ar: 'العربية 🇸🇦', es: 'Español 🇪🇸', fr: 'Français 🇫🇷',
                de: 'Deutsch 🇩🇪', zh: '中文 🇨🇳'
            };
            
            document.getElementById('currentLanguage').textContent = `Current: ${langNames[lang]}`;
            alert(`✅ Language changed to ${langNames[lang]}!\n\nNote: Full translation will be applied on next page load.`);
            
            setTimeout(() => {
                closeLanguageModal();
            }, 1500);
        }

        // Quick language change from main search section
        function changeLanguageQuick(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            
            const langNames = {
                en: 'English 🇬🇧', 
                ur: 'اردو 🇵🇰', 
                hi: 'हिंदी 🇮🇳', 
                ar: 'العربية 🇸🇦', 
                es: 'Español 🇪🇸', 
                fr: 'Français 🇫🇷',
                de: 'Deutsch 🇩🇪', 
                zh: '中文 🇨🇳'
            };
            
            // Update status message
            const statusEl = document.getElementById('langStatus');
            statusEl.textContent = `✅ ${langNames[lang]} activated!`;
            statusEl.style.animation = 'successPop 0.5s ease';
            
            // Update modal display if exists
            const currentLangEl = document.getElementById('currentLanguage');
            if (currentLangEl) {
                currentLangEl.textContent = `Current: ${langNames[lang]}`;
            }
            
            // Clear status after 3 seconds
            setTimeout(() => {
                statusEl.textContent = '';
            }, 3000);
        }

        // Initialize language selector on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedLang = localStorage.getItem('language') || 'en';
            const selector = document.getElementById('languageSelectorMain');
            if (selector) {
                selector.value = savedLang;
                
                const langNames = {
                    en: 'English 🇬🇧', 
                    ur: 'اردو 🇵🇰', 
                    hi: 'हिंदी 🇮🇳', 
                    ar: 'العربية 🇸🇦', 
                    es: 'Español 🇪🇸', 
                    fr: 'Français 🇫🇷',
                    de: 'Deutsch 🇩🇪', 
                    zh: '中文 🇨🇳'
                };
                
                if (savedLang !== 'en') {
                    document.getElementById('langStatus').textContent = `${langNames[savedLang]}`;
                }
            }
        });

        // AIR QUALITY MAP
        function showAirQualityMap() {
            playSound(900, 150);
            document.getElementById('mapModal').style.display = 'block';
        }

        function closeMapModal() {
            document.getElementById('mapModal').style.display = 'none';
        }

        // CHATBOT
        function openChatbot() {
            playSound(900, 150);
            document.getElementById('chatbotModal').style.display = 'block';
        }

        function closeChatbotModal() {
            document.getElementById('chatbotModal').style.display = 'none';
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const chatMessages = document.getElementById('chatMessages');
            
            // User message
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user-message';
            userMsg.innerHTML = `<strong>You:</strong> ${message}`;
            chatMessages.appendChild(userMsg);
            
            input.value = '';
            
            // Bot response (simulated)
            setTimeout(() => {
                const botMsg = document.createElement('div');
                botMsg.className = 'chat-message bot-message';
                botMsg.innerHTML = `<strong>🤖 AQI Bot:</strong> ${getBotResponse(message)}`;
                chatMessages.appendChild(botMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1000);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getBotResponse(message) {
            const msg = message.toLowerCase();
            
            // Get current language from localStorage or default to English
            const currentLang = localStorage.getItem('language') || 'en';
            
            // Multilingual responses for all 8 languages
            const responses = {
                // === AQI BASICS ===
                whatIsAqi: {
                    en: '🌍 <strong>AQI (Air Quality Index)</strong> is a standardized indicator of air pollution levels.<br><br>📊 <strong>Scale:</strong><br>• 0-50: Good 😊<br>• 51-100: Moderate 😐<br>• 101-150: Unhealthy for Sensitive Groups ⚠️<br>• 151-200: Unhealthy 😷<br>• 201-300: Very Unhealthy 🚨<br>• 301+: Hazardous ☠️',
                    ur: '🌍 <strong>AQI (Air Quality Index)</strong> ek standardized indicator hai jo air pollution level batata hai.<br><br>📊 <strong>Scale:</strong><br>• 0-50: Acha 😊 (Good)<br>• 51-100: Moderate 😐 (Theek hai)<br>• 101-150: Sensitive logo ke liye unhealthy ⚠️<br>• 151-200: Unhealthy 😷 (Kharab)<br>• 201-300: Bahut kharab 🚨<br>• 301+: Hazardous ☠️ (Khatarnak)',
                    hi: '🌍 <strong>AQI (वायु गुणवत्ता सूचकांक)</strong> एक मानकीकृत संकेतक है जो वायु प्रदूषण स्तर बताता है।<br><br>📊 <strong>स्केल:</strong><br>• 0-50: अच्छा 😊<br>• 51-100: मध्यम 😐<br>• 101-150: संवेदनशील समूहों के लिए अस्वस्थ ⚠️<br>• 151-200: अस्वस्थ 😷<br>• 201-300: बहुत अस्वस्थ 🚨<br>• 301+: खतरनाक ☠️',
                    ar: '🌍 <strong>AQI (مؤشر جودة الهواء)</strong> هو مؤشر موحد لمستويات تلوث الهواء.<br><br>📊 <strong>المقياس:</strong><br>• 0-50: جيد 😊<br>• 51-100: معتدل 😐<br>• 101-150: غير صحي للمجموعات الحساسة ⚠️<br>• 151-200: غير صحي 😷<br>• 201-300: غير صحي للغاية 🚨<br>• 301+: خطير ☠️',
                    es: '🌍 <strong>AQI (Índice de Calidad del Aire)</strong> es un indicador estandarizado de los niveles de contaminación del aire.<br><br>📊 <strong>Escala:</strong><br>• 0-50: Bueno 😊<br>• 51-100: Moderado 😐<br>• 101-150: Insalubre para grupos sensibles ⚠️<br>• 151-200: Insalubre 😷<br>• 201-300: Muy insalubre 🚨<br>• 301+: Peligroso ☠️',
                    fr: '🌍 <strong>AQI (Indice de Qualité de l\'Air)</strong> est un indicateur standardisé des niveaux de pollution atmosphérique.<br><br>📊 <strong>Échelle:</strong><br>• 0-50: Bon 😊<br>• 51-100: Modéré 😐<br>• 101-150: Malsain pour les groupes sensibles ⚠️<br>• 151-200: Malsain 😷<br>• 201-300: Très malsain 🚨<br>• 301+: Dangereux ☠️',
                    de: '🌍 <strong>AQI (Luftqualitätsindex)</strong> ist ein standardisierter Indikator für Luftverschmutzungsniveaus.<br><br>📊 <strong>Skala:</strong><br>• 0-50: Gut 😊<br>• 51-100: Mäßig 😐<br>• 101-150: Ungesund für empfindliche Gruppen ⚠️<br>• 151-200: Ungesund 😷<br>• 201-300: Sehr ungesund 🚨<br>• 301+: Gefährlich ☠️',
                    zh: '🌍 <strong>AQI (空气质量指数)</strong> 是空气污染水平的标准化指标。<br><br>📊 <strong>等级:</strong><br>• 0-50: 良好 😊<br>• 51-100: 中等 😐<br>• 101-150: 对敏感人群不健康 ⚠️<br>• 151-200: 不健康 😷<br>• 201-300: 非常不健康 🚨<br>• 301+: 危险 ☠️'
                },
                pm25: {
                    en: '🌫️ <strong>PM2.5 (Particulate Matter 2.5):</strong><br><br>Tiny particles less than 2.5 micrometers in diameter (30x thinner than human hair!).<br><br>⚠️ <strong>Health Effects:</strong><br>• Penetrates deep into lungs<br>• Causes respiratory issues<br>• Linked to heart disease<br><br>🏭 <strong>Sources:</strong> Vehicle emissions, industrial smoke, construction dust, burning',
                    ur: '🌫️ <strong>PM2.5 (Particulate Matter 2.5):</strong><br><br>Bahut chhote particles jo 2.5 micrometers se kam hote hain (human hair se 30 guna patla!).<br><br>⚠️ <strong>Health Effects:</strong><br>• Lungs ke andar tak jaate hain<br>• Sans ki problem<br>• Dil ki bimari ka khatra<br><br>🏭 <strong>Sources:</strong> Gaadi ka dhuaan, factory smoke, construction dust, jalana',
                    hi: '🌫️ <strong>PM2.5 (कण पदार्थ 2.5):</strong><br><br>2.5 माइक्रोमीटर से कम व्यास के छोटे कण (मानव बाल से 30 गुना पतला!)।<br><br>⚠️ <strong>स्वास्थ्य प्रभाव:</strong><br>• फेफड़ों में गहराई तक प्रवेश<br>• श्वसन समस्याएं<br>• हृदय रोग से जुड़ा<br><br>🏭 <strong>स्रोत:</strong> वाहन उत्सर्जन, औद्योगिक धुआं, निर्माण धूल',
                    ar: '🌫️ <strong>PM2.5 (الجسيمات الدقيقة 2.5):</strong><br><br>جزيئات صغيرة أقل من 2.5 ميكرومتر (أرق 30 مرة من شعر الإنسان!).<br><br>⚠️ <strong>التأثيرات الصحية:</strong><br>• تخترق عميقاً في الرئتين<br>• تسبب مشاكل تنفسية<br>• مرتبطة بأمراض القلب<br><br>🏭 <strong>المصادر:</strong> انبعاثات المركبات، دخان المصانع، غبار البناء',
                    es: '🌫️ <strong>PM2.5 (Material Particulado 2.5):</strong><br><br>Partículas diminutas de menos de 2.5 micrómetros de diámetro (¡30 veces más delgadas que un cabello humano!).<br><br>⚠️ <strong>Efectos en la Salud:</strong><br>• Penetra profundamente en los pulmones<br>• Causa problemas respiratorios<br>• Vinculado a enfermedades cardíacas<br><br>🏭 <strong>Fuentes:</strong> Emisiones de vehículos, humo industrial, polvo de construcción',
                    fr: '🌫️ <strong>PM2.5 (Particules Fines 2.5):</strong><br><br>Particules minuscules de moins de 2.5 micromètres de diamètre (30 fois plus fines qu\'un cheveu humain!).<br><br>⚠️ <strong>Effets sur la Santé:</strong><br>• Pénètre profondément dans les poumons<br>• Cause des problèmes respiratoires<br>• Lié aux maladies cardiaques<br><br>🏭 <strong>Sources:</strong> Émissions de véhicules, fumée industrielle, poussière de construction',
                    de: '🌫️ <strong>PM2.5 (Feinstaub 2.5):</strong><br><br>Winzige Partikel mit einem Durchmesser von weniger als 2,5 Mikrometern (30-mal dünner als ein menschliches Haar!).<br><br>⚠️ <strong>Gesundheitseffekte:</strong><br>• Dringt tief in die Lungen ein<br>• Verursacht Atemprobleme<br>• Verbunden mit Herzkrankheiten<br><br>🏭 <strong>Quellen:</strong> Fahrzeugemissionen, Industrierauch, Baustaub',
                    zh: '🌫️ <strong>PM2.5 (细颗粒物 2.5):</strong><br><br>直径小于2.5微米的微小颗粒（比人类头发细30倍！）。<br><br>⚠️ <strong>健康影响:</strong><br>• 深入肺部<br>• 引起呼吸问题<br>• 与心脏病相关<br><br>🏭 <strong>来源:</strong> 车辆排放、工业烟雾、建筑粉尘、燃烧'
                },
                mask: {
                    en: '😷 <strong>Masks for Air Pollution:</strong><br><br>✅ <strong>Effective:</strong><br>• N95/N99 respirators (95-99% filtration)<br>• KN95 masks<br>• P100 respirators<br><br>❌ <strong>NOT Effective:</strong><br>• Surgical masks (not sealed)<br>• Cloth masks<br>• Bandanas<br><br>💡 <strong>When to Wear:</strong> AQI > 150',
                    ur: '😷 <strong>Masks for Air Pollution:</strong><br><br>✅ <strong>Effective (Kaam karte hain):</strong><br>• N95/N99 respirators (95-99% filtration)<br>• KN95 masks<br>• P100 respirators<br><br>❌ <strong>NOT Effective (Kaam nahi karte):</strong><br>• Surgical masks (sealed nahi)<br>• Kapde ke masks<br>• Bandanas<br><br>💡 <strong>Kab pehne:</strong> Jab AQI > 150 ho',
                    hi: '😷 <strong>वायु प्रदूषण के लिए मास्क:</strong><br><br>✅ <strong>प्रभावी:</strong><br>• N95/N99 श्वासयंत्र (95-99% निस्पंदन)<br>• KN95 मास्क<br>• P100 श्वासयंत्र<br><br>❌ <strong>प्रभावी नहीं:</strong><br>• सर्जिकल मास्क (सील नहीं)<br>• कपड़े के मास्क<br>• बंदन<br><br>💡 <strong>कब पहनें:</strong> AQI > 150',
                    ar: '😷 <strong>أقنعة تلوث الهواء:</strong><br><br>✅ <strong>فعال:</strong><br>• أجهزة التنفس N95/N99 (ترشيح 95-99٪)<br>• أقنعة KN95<br>• أجهزة التنفس P100<br><br>❌ <strong>غير فعال:</strong><br>• أقنعة جراحية (غير محكمة)<br>• أقنعة قماشية<br>• باندانا<br><br>💡 <strong>متى ترتدي:</strong> AQI > 150',
                    es: '😷 <strong>Mascarillas para Contaminación:</strong><br><br>✅ <strong>Efectivo:</strong><br>• Respiradores N95/N99 (95-99% filtración)<br>• Mascarillas KN95<br>• Respiradores P100<br><br>❌ <strong>NO Efectivo:</strong><br>• Mascarillas quirúrgicas (no selladas)<br>• Mascarillas de tela<br>• Pañuelos<br><br>💡 <strong>Cuándo usar:</strong> AQI > 150',
                    fr: '😷 <strong>Masques pour Pollution:</strong><br><br>✅ <strong>Efficace:</strong><br>• Respirateurs N95/N99 (filtration 95-99%)<br>• Masques KN95<br>• Respirateurs P100<br><br>❌ <strong>NON Efficace:</strong><br>• Masques chirurgicaux (non scellés)<br>• Masques en tissu<br>• Bandanas<br><br>💡 <strong>Quand porter:</strong> AQI > 150',
                    de: '� <strong>Masken für Luftverschmutzung:</strong><br><br>✅ <strong>Wirksam:</strong><br>• N95/N99 Atemschutzmasken (95-99% Filterung)<br>• KN95 Masken<br>• P100 Atemschutzmasken<br><br>❌ <strong>NICHT Wirksam:</strong><br>• Chirurgische Masken (nicht versiegelt)<br>• Stoffmasken<br>• Bandanas<br><br>💡 <strong>Wann tragen:</strong> AQI > 150',
                    zh: '� <strong>空气污染口罩:</strong><br><br>✅ <strong>有效:</strong><br>• N95/N99口罩（95-99%过滤）<br>• KN95口罩<br>• P100口罩<br><br>❌ <strong>无效:</strong><br>• 医用口罩（未密封）<br>• 布口罩<br>• 围巾<br><br>💡 <strong>何时佩戴:</strong> AQI > 150'
                },
                outdoor: {
                    en: '🚶 <strong>Outdoor Activity Safety:</strong><br><br>✅ <strong>AQI 0-50:</strong> Perfect! Enjoy outdoors freely<br>� <strong>AQI 51-100:</strong> Generally safe<br>🟡 <strong>AQI 101-150:</strong> Sensitive groups be careful<br>🟠 <strong>AQI 151-200:</strong> Limit time outdoors<br>🔴 <strong>AQI 201+:</strong> Stay indoors!',
                    ur: '🚶 <strong>Bahar Jane Ki Safety:</strong><br><br>✅ <strong>AQI 0-50:</strong> Bilkul safe! Khul ke bahar jao<br>🟢 <strong>AQI 51-100:</strong> Generally theek hai<br>� <strong>AQI 101-150:</strong> Sensitive logo ko careful rehna chahiye<br>🟠 <strong>AQI 151-200:</strong> Bahar waqt kam karo<br>🔴 <strong>AQI 201+:</strong> Ghar ke andar raho!',
                    hi: '🚶 <strong>बाहरी गतिविधि सुरक्षा:</strong><br><br>✅ <strong>AQI 0-50:</strong> बिल्कुल सही! स्वतंत्र रूप से बाहर आनंद लें<br>� <strong>AQI 51-100:</strong> आम तौर पर सुरक्षित<br>🟡 <strong>AQI 101-150:</strong> संवेदनशील समूह सावधान रहें<br>🟠 <strong>AQI 151-200:</strong> बाहर समय सीमित करें<br>🔴 <strong>AQI 201+:</strong> अंदर रहें!',
                    ar: '🚶 <strong>سلامة النشاط الخارجي:</strong><br><br>✅ <strong>AQI 0-50:</strong> مثالي! استمتع بالهواء الطلق بحرية<br>🟢 <strong>AQI 51-100:</strong> آمن بشكل عام<br>🟡 <strong>AQI 101-150:</strong> المجموعات الحساسة احذر<br>🟠 <strong>AQI 151-200:</strong> حدد الوقت في الهواء الطلق<br>🔴 <strong>AQI 201+:</strong> ابق في الداخل!',
                    es: '🚶 <strong>Seguridad Actividad Exterior:</strong><br><br>✅ <strong>AQI 0-50:</strong> ¡Perfecto! Disfruta al aire libre libremente<br>🟢 <strong>AQI 51-100:</strong> Generalmente seguro<br>🟡 <strong>AQI 101-150:</strong> Grupos sensibles tengan cuidado<br>🟠 <strong>AQI 151-200:</strong> Limita tiempo al aire libre<br>🔴 <strong>AQI 201+:</strong> ¡Quédate adentro!',
                    fr: '🚶 <strong>Sécurité Activité Extérieure:</strong><br><br>✅ <strong>AQI 0-50:</strong> Parfait! Profitez librement de l\'extérieur<br>🟢 <strong>AQI 51-100:</strong> Généralement sûr<br>🟡 <strong>AQI 101-150:</strong> Groupes sensibles soyez prudents<br>🟠 <strong>AQI 151-200:</strong> Limitez le temps à l\'extérieur<br>🔴 <strong>AQI 201+:</strong> Restez à l\'intérieur!',
                    de: '� <strong>Sicherheit Outdoor-Aktivität:</strong><br><br>✅ <strong>AQI 0-50:</strong> Perfekt! Genießen Sie frei im Freien<br>🟢 <strong>AQI 51-100:</strong> Allgemein sicher<br>🟡 <strong>AQI 101-150:</strong> Empfindliche Gruppen Vorsicht<br>🟠 <strong>AQI 151-200:</strong> Zeit im Freien begrenzen<br>� <strong>AQI 201+:</strong> Drinnen bleiben!',
                    zh: '🚶 <strong>户外活动安全:</strong><br><br>✅ <strong>AQI 0-50:</strong> 完美！自由享受户外<br>🟢 <strong>AQI 51-100:</strong> 一般安全<br>🟡 <strong>AQI 101-150:</strong> 敏感人群小心<br>🟠 <strong>AQI 151-200:</strong> 限制户外时间<br>🔴 <strong>AQI 201+:</strong> 待在室内！'
                },
                greeting: {
                    en: '👋 Hello! I\'m your AQI assistant. Ask me anything about air quality, pollution, health effects, or protection tips! Try: "What is PM2.5?" or "Is it safe to exercise?"',
                    ur: '👋 Assalam-o-Alaikum / Namaste! Main aapka AQI assistant hoon. Mujh se air quality, pollution, health effects, ya protection ke bare mein kuch bhi pooch sakte ho! Try karo: "PM2.5 kya hai?" ya "Exercise karna safe hai kya?"',
                    hi: '👋 नमस्ते! मैं आपका AQI सहायक हूं। मुझसे वायु गुणवत्ता, प्रदूषण, स्वास्थ्य प्रभाव या सुरक्षा युक्तियों के बारे में कुछ भी पूछें! प्रयास करें: "PM2.5 क्या है?" या "व्यायाम करना सुरक्षित है?"',
                    ar: '👋 مرحباً! أنا مساعد AQI الخاص بك. اسألني أي شيء عن جودة الهواء أو التلوث أو الآثار الصحية أو نصائح الحماية! جرب: "ما هو PM2.5؟" أو "هل من الآمن ممارسة الرياضة؟"',
                    es: '👋 ¡Hola! Soy tu asistente AQI. ¡Pregúntame sobre calidad del aire, contaminación, efectos en la salud o consejos de protección! Prueba: "¿Qué es PM2.5?" o "¿Es seguro hacer ejercicio?"',
                    fr: '👋 Bonjour! Je suis votre assistant AQI. Posez-moi des questions sur la qualité de l\'air, la pollution, les effets sur la santé ou les conseils de protection! Essayez: "Qu\'est-ce que PM2.5?" ou "Est-il sûr de faire de l\'exercice?"',
                    de: '👋 Hallo! Ich bin Ihr AQI-Assistent. Fragen Sie mich alles über Luftqualität, Verschmutzung, Gesundheitseffekte oder Schutz-Tipps! Versuchen Sie: "Was ist PM2.5?" oder "Ist es sicher zu trainieren?"',
                    zh: '👋 你好！我是你的AQI助手。问我关于空气质量、污染、健康影响或保护提示的任何问题！试试："什么是PM2.5？"或"运动安全吗？"'
                }
            };
            
            // === DETECT QUESTION TYPE AND RETURN MULTILINGUAL RESPONSE ===
            if (msg.includes('what is aqi') || msg === 'aqi' || msg.includes('aqi kya') || msg.includes('aqi क्या')) {
                return responses.whatIsAqi[currentLang];
            }
            
            if (msg.includes('pm2.5') || msg.includes('pm 2.5')) {
                return responses.pm25[currentLang];
            }
            
            if (msg.includes('mask') || msg.includes('n95') || msg.includes('मास्क')) {
                return responses.mask[currentLang];
            }
            
            if (msg.includes('safe to go out') || msg.includes('outdoor') || msg.includes('outside') || 
                msg.includes('bahar jana') || msg.includes('bahar') || msg.includes('बाहर')) {
                return responses.outdoor[currentLang];
            }
            
            if (msg.includes('hello') || msg.includes('hi') || msg.includes('hey') || 
                msg.includes('assalam') || msg.includes('namaste') || msg.includes('salam') ||
                msg.includes('नमस्ते') || msg.includes('مرحبا') || msg.includes('hola') || 
                msg.includes('bonjour') || msg.includes('hallo') || msg.includes('你好')) {
                return responses.greeting[currentLang];
            }
            
            // For other questions, use English (can be extended to multilingual later)
            if (msg.includes('how aqi calculated') || msg.includes('aqi calculation') || msg.includes('aqi kaise calculate')) {
                return '🧮 <strong>AQI Calculation:</strong><br><br>AQI is calculated using the EPA formula based on pollutant concentrations, primarily PM2.5. The formula converts PM2.5 values (µg/m³) to AQI using breakpoint tables.<br><br>📊 Example: PM2.5 of 35.5 µg/m³ = AQI of 100';
            }
            
            if (msg.includes('who created aqi') || msg.includes('aqi history')) {
                return '📜 <strong>AQI History:</strong><br><br>The AQI was created by the U.S. Environmental Protection Agency (EPA) in 1999 to provide simple, uniform air quality information. It replaced the older Pollutant Standards Index (PSI) from 1976.';
            }
            
            // === POLLUTANTS (remaining ones) ===
            if (msg.includes('pm10') || msg.includes('pm 10')) {
                return '💨 <strong>PM10 (Particulate Matter 10):</strong><br><br>Particles less than 10 micrometers in diameter.<br><br>📍 <strong>Sources:</strong> Dust, pollen, mold, construction sites, roads<br><br>⚠️ <strong>Effects:</strong> Irritates airways, aggravates asthma, reduces lung function';
            }
            
            if (msg.includes('co') && (msg.includes('carbon monoxide') || msg.includes('what is co'))) {
                return '☁️ <strong>CO (Carbon Monoxide):</strong><br><br>Colorless, odorless gas produced by incomplete combustion.<br><br>🚗 <strong>Main Sources:</strong><br>• Vehicle exhaust<br>• Gas stoves<br>• Furnaces<br>• Generators<br><br>☠️ <strong>Danger:</strong> Binds to hemoglobin, reducing oxygen delivery to organs. High levels can be fatal!';
            }
            
            if (msg.includes('no2') || msg.includes('nitrogen dioxide')) {
                return '🏭 <strong>NO2 (Nitrogen Dioxide):</strong><br><br>Reddish-brown gas with pungent odor.<br><br>🚗 <strong>Sources:</strong> Vehicle engines, power plants, industrial facilities<br><br>⚠️ <strong>Health Impact:</strong> Irritates airways, aggravates asthma, reduces immunity to lung infections';
            }
            
            if (msg.includes('so2') || msg.includes('sulfur dioxide') || msg.includes('sulphur')) {
                return '🌋 <strong>SO2 (Sulfur Dioxide):</strong><br><br>Colorless gas with sharp smell.<br><br>🏭 <strong>Sources:</strong> Coal/oil burning, volcanoes, industrial processes<br><br>⚠️ <strong>Effects:</strong> Respiratory problems, asthma attacks, acid rain formation';
            }
            
            if (msg.includes('ozone') || msg.includes('o3')) {
                return '☀️ <strong>Ozone (O3):</strong><br><br>Ground-level ozone forms when pollutants react in sunlight.<br><br>⚠️ <strong>Not the same as ozone layer!</strong><br><br>🏥 <strong>Health Effects:</strong> Chest pain, coughing, throat irritation, worsens asthma<br><br>🌞 Worse on hot, sunny days';
            }
            
            // === HEALTH QUESTIONS ===
            if (msg.includes('exercise') || msg.includes('workout') || msg.includes('run')) {
                return '🏃 <strong>Exercise Guidelines by AQI:</strong><br><br>✅ <strong>0-50 (Good):</strong> Exercise freely!<br>🟡 <strong>51-100 (Moderate):</strong> Safe for most people<br>🟠 <strong>101-150:</strong> Sensitive groups: reduce intensity<br>🔴 <strong>151-200:</strong> Everyone: limit outdoor exercise<br>⛔ <strong>201+:</strong> Move workouts indoors!';
            }
            
            if (msg.includes('children') || msg.includes('kids') || msg.includes('school')) {
                return '👶 <strong>Children & Air Quality:</strong><br><br>Children are MORE vulnerable because:<br>• Lungs still developing<br>• Breathe faster than adults<br>• Spend more time outdoors<br><br>📚 <strong>School Guidelines:</strong><br>• AQI > 100: Limit outdoor recess<br>• AQI > 150: Indoor activities only<br>• AQI > 200: Consider school closure';
            }
            
            if (msg.includes('pregnant') || msg.includes('pregnancy')) {
                return '🤰 <strong>Pregnancy & Air Pollution:</strong><br><br>⚠️ <strong>Risks:</strong><br>• Low birth weight<br>• Preterm birth<br>• Developmental issues<br><br>💡 <strong>Protection:</strong><br>• Stay indoors on high AQI days<br>• Use air purifiers<br>• Avoid traffic-heavy areas<br>• Wear N95 masks outdoors';
            }
            
            if (msg.includes('elderly') || msg.includes('senior') || msg.includes('old')) {
                return '👵 <strong>Elderly & Air Quality:</strong><br><br>Seniors are at higher risk due to:<br>• Weakened immune systems<br>• Existing health conditions<br>• Reduced lung capacity<br><br>🛡️ <strong>Precautions:</strong><br>• Monitor AQI daily<br>• Stay indoors when AQI > 100<br>• Keep medications handy<br>• Use air purifiers';
            }
            
            if (msg.includes('asthma') || msg.includes('breathing problem')) {
                return '🫁 <strong>Asthma & Air Pollution:</strong><br><br>⚠️ <strong>High Risk!</strong> Poor air triggers asthma attacks.<br><br>💊 <strong>Protection Tips:</strong><br>1. Check AQI before going out<br>2. Always carry inhaler<br>3. Avoid outdoor activity when AQI > 100<br>4. Close windows on high AQI days<br>5. Use HEPA air purifiers indoors';
            }
            
            // Mask question already handled above in multilingual responses
            // Outdoor questions already handled above in multilingual responses
            
            // === OTHER OUTDOOR ACTIVITIES ===
            if (msg.includes('cycling') || msg.includes('bike') || msg.includes('biking')) {
                return '🚴 <strong>Cycling in Pollution:</strong><br><br>Cyclists breathe 2-3x more air than walkers!<br><br>🟢 <strong>Safe:</strong> AQI < 100<br>⚠️ <strong>Caution:</strong> AQI 100-150 (use mask)<br>🛑 <strong>Avoid:</strong> AQI > 150<br><br>💡 Tips:<br>• Choose routes away from traffic<br>• Avoid rush hours<br>• Wear N95 mask if AQI > 100';
            }
            
            if (msg.includes('walking') || msg.includes('walk') || msg.includes('jogging')) {
                return '🚶 <strong>Walking/Jogging Guidelines:</strong><br><br>✅ <strong>Safe:</strong> AQI 0-100<br>⚠️ <strong>Limit Duration:</strong> AQI 101-150<br>🛑 <strong>Avoid:</strong> AQI 151+<br><br>💡 Best Times:<br>• Early morning (6-8 AM)<br>• Late evening (after 8 PM)<br>• Avoid afternoon peak pollution';
            }
            
            // === INDOOR AIR QUALITY ===
            if (msg.includes('indoor') || msg.includes('inside') || msg.includes('home') || 
                msg.includes('ghar') || msg.includes('andar')) {
                if (isUrduHindi) {
                    return '🏠 <strong>Ghar Ki Air Quality Tips:</strong><br><br>✅ <strong>Indoor Air Behtar Karne Ke Liye:</strong><br>1. HEPA air purifiers use karo<br>2. AQI > 100 hone pe khidkiyaan band rakho<br>3. Ghar ke andar smoking nahi<br>4. Khana pakate waqt ventilation karo<br>5. Indoor plants lagao (spider plant, peace lily)<br>6. Regular safai (HEPA filter vacuum se)<br>7. Humidity control karo (30-50%)';
                }
                return '🏠 <strong>Indoor Air Quality Tips:</strong><br><br>✅ <strong>Improve Indoor Air:</strong><br>1. Use HEPA air purifiers<br>2. Keep windows closed when AQI > 100<br>3. No smoking indoors<br>4. Ventilate when cooking<br>5. Add indoor plants (spider plant, peace lily)<br>6. Regular cleaning (vacuum with HEPA filter)<br>7. Control humidity (30-50%)';
            }
            
            if (msg.includes('air purifier') || msg.includes('purifier')) {
                if (isUrduHindi) {
                    return '🌬️ <strong>Air Purifiers:</strong><br><br>✅ <strong>Best Type:</strong> HEPA filters (99.97% particles remove karta hai)<br><br>📏 <strong>Room Size:</strong> CADR rating check karo (Clean Air Delivery Rate)<br><br>� <strong>Faida hai?</strong> HAA! Especially agar:<br>• AQI aksar > 100 hota ho<br>• Asthma/allergies ho<br>• Ghar mein bachche/buzurg ho<br><br>🔄 Maintain: Filters har 6-12 mahine change karo';
                }
                return '🌬️ <strong>Air Purifiers:</strong><br><br>✅ <strong>Best Type:</strong> HEPA filters (99.97% particle removal)<br><br>�📏 <strong>Room Size:</strong> Check CADR rating (Clean Air Delivery Rate)<br><br>💰 <strong>Worth it?</strong> YES! Especially if:<br>• AQI frequently > 100<br>• You have asthma/allergies<br>• Children/elderly at home<br><br>🔄 Maintain: Change filters every 6-12 months';
            }
            
            if (msg.includes('plants') || msg.includes('indoor plant') || msg.includes('paudhe')) {
                if (isUrduHindi) {
                    return '🌿 <strong>Air Saaf Karne Wale Plants:</strong><br><br>NASA study ke mutabiq best performers:<br>1. 🌱 Spider Plant<br>2. 🌿 Peace Lily<br>3. 🍃 Snake Plant (Saanp ka paudha)<br>4. 🌴 Areca Palm<br>5. 🌺 Boston Fern<br><br>⚠️ <strong>Note:</strong> Plants help karte hain par akele kaafi nahi. Air purifiers ke saath best results!';
                }
                return '🌿 <strong>Air-Purifying Plants:</strong><br><br>Top performers by NASA study:<br>1. 🌱 Spider Plant<br>2. 🌿 Peace Lily<br>3. 🍃 Snake Plant (Mother-in-law\'s Tongue)<br>4. 🌴 Areca Palm<br>5. 🌺 Boston Fern<br><br>⚠️ <strong>Note:</strong> Plants help but NOT enough alone. Use with air purifiers for best results!';
            }
            
            // === SOURCES & CAUSES ===
            if (msg.includes('cause') || msg.includes('source') || msg.includes('why pollution')) {
                return '🏭 <strong>Main Pollution Sources:</strong><br><br>1. 🚗 <strong>Transportation (30%):</strong> Cars, trucks, buses<br>2. 🏭 <strong>Industry (25%):</strong> Factories, power plants<br>3. 🏠 <strong>Residential (20%):</strong> Cooking, heating<br>4. 🔥 <strong>Biomass Burning (15%):</strong> Crop stubble, wood<br>5. 🏗️ <strong>Construction (10%):</strong> Dust, equipment';
            }
            
            if (msg.includes('traffic') || msg.includes('vehicle') || msg.includes('car')) {
                return '🚗 <strong>Traffic Pollution:</strong><br><br>Vehicles emit:<br>• PM2.5 & PM10<br>• NO2<br>• CO<br>• Hydrocarbons<br><br>💡 <strong>Reduce Exposure:</strong><br>• Walk on side streets, not main roads<br>• Avoid rush hours<br>• Keep car windows closed in traffic<br>• Use cabin air filters';
            }
            
            if (msg.includes('smoke') || msg.includes('smoking') || msg.includes('cigarette')) {
                return '🚬 <strong>Smoking & Air Quality:</strong><br><br>⚠️ One cigarette = AQI 500+ indoors!<br><br>Secondhand smoke contains:<br>• 7,000+ chemicals<br>• 70+ carcinogens<br><br>🏠 <strong>Impact:</strong><br>• Stays in air for hours<br>• Settles on surfaces<br>• Harms children most<br><br>🚭 <strong>Solution:</strong> Smoke outdoors ONLY';
            }
            
            if (msg.includes('cooking') || msg.includes('kitchen')) {
                return '🍳 <strong>Cooking & Indoor Air:</strong><br><br>⚠️ Cooking (esp. frying) releases PM2.5!<br><br>💡 <strong>Reduce Pollution:</strong><br>1. Use exhaust fan/chimney<br>2. Open windows while cooking<br>3. Electric > Gas stoves<br>4. Avoid deep frying<br>5. Clean regularly';
            }
            
            // === WEATHER & SEASONS ===
            if (msg.includes('winter') || msg.includes('cold')) {
                return '❄️ <strong>Winter Air Quality:</strong><br><br>⚠️ <strong>Worse in winter</strong> because:<br>• Temperature inversion traps pollution<br>• More heating/burning<br>• Less wind dispersal<br>• Lower mixing height<br><br>📊 AQI typically 2-3x higher than summer!';
            }
            
            if (msg.includes('summer') || msg.includes('hot')) {
                return '☀️ <strong>Summer Air Quality:</strong><br><br>🟢 Generally better but:<br>• Ozone increases in heat<br>• Dust storms more common<br>• AC reduces outdoor exposure<br><br>💡 Ozone peaks 2-8 PM on hot days';
            }
            
            if (msg.includes('rain') || msg.includes('raining')) {
                return '🌧️ <strong>Rain & Air Quality:</strong><br><br>✅ Rain is nature\'s air purifier!<br><br>💧 <strong>Benefits:</strong><br>• Washes away particles<br>• AQI drops 50-70%<br>• Effect lasts 2-6 hours<br><br>Best time for outdoor activities: After rain! ☔';
            }
            
            if (msg.includes('wind') || msg.includes('windy')) {
                return '💨 <strong>Wind & Air Quality:</strong><br><br>🌬️ Strong wind = Good dispersion<br><br>✅ <strong>Benefits:</strong><br>• Disperses pollutants<br>• Reduces local concentration<br><br>⚠️ <strong>But:</strong> Can carry dust/pollution from other areas';
            }
            
            // === LOCATIONS ===
            if (msg.includes('delhi') || msg.includes('india')) {
                if (isUrduHindi) {
                    return '🇮🇳 <strong>India/Delhi Air Quality:</strong><br><br>⚠️ Duniya ke sabse zyada polluted regions mein se ek<br><br>🏭 <strong>Main Causes:</strong><br>• Gadiyon ka dhuaan<br>• Fasal jalana (Oct-Nov)<br>• Construction ki dhool<br>• Factory pollution<br>• Diwali ke patakhe<br><br>📊 Sardi mein AQI aksar > 300 hota hai!';
                }
                return '🇮🇳 <strong>India/Delhi Air Quality:</strong><br><br>⚠️ One of world\'s most polluted regions<br><br>🏭 <strong>Main Causes:</strong><br>• Vehicle emissions<br>• Crop burning (Oct-Nov)<br>• Construction dust<br>• Industrial pollution<br>• Diwali firecrackers<br><br>📊 AQI often > 300 in winter!';
            }
            
            if (msg.includes('pakistan') || msg.includes('lahore') || msg.includes('karachi')) {
                if (isUrduHindi) {
                    return '🇵🇰 <strong>Pakistan Air Quality:</strong><br><br>Lahore, Karachi jaise bade shehron mein pollution bahut hai.<br><br>🏭 <strong>Wajoohat:</strong><br>• Traffic ki rush<br>• Factory ka dhuaan<br>• Brick kilns (eent ke bhatte)<br>• Fasal jalana<br>• Dhool<br><br>📊 Lahore duniya ke top 10 polluted cities mein hai';
                }
                return '🇵🇰 <strong>Pakistan Air Quality:</strong><br><br>Major cities like Lahore, Karachi struggle with pollution.<br><br>🏭 <strong>Causes:</strong><br>• Traffic congestion<br>• Industrial emissions<br>• Brick kilns<br>• Crop burning<br>• Dust<br><br>📊 Lahore ranks among top 10 polluted cities globally';
            }
            
            if (msg.includes('china') || msg.includes('beijing')) {
                return '🇨🇳 <strong>China Air Quality:</strong><br><br>📈 Improving! Beijing AQI dropped 50% since 2013<br><br>✅ <strong>Actions Taken:</strong><br>• Factory regulations<br>• Electric vehicles<br>• Coal reduction<br>• Air quality monitoring<br><br>Still challenges remain in winter months';
            }
            
            // === PROTECTION & SOLUTIONS ===
            if (msg.includes('protect') || msg.includes('prevention') || msg.includes('reduce')) {
                return '🛡️ <strong>How to Protect Yourself:</strong><br><br>1. 📱 Check AQI daily<br>2. 🏠 Stay indoors when AQI > 150<br>3. 😷 Wear N95 mask outdoors<br>4. 🌬️ Use air purifiers at home<br>5. 🪟 Close windows on bad days<br>6. 🚗 Use cabin air filters<br>7. 💪 Boost immunity (diet, exercise)<br>8. 💧 Stay hydrated';
            }
            
            if (msg.includes('government') || msg.includes('policy') || msg.includes('law')) {
                return '🏛️ <strong>Government Actions:</strong><br><br>✅ <strong>Policies:</strong><br>• Emission standards (BS-VI, Euro 6)<br>• Odd-even vehicle schemes<br>• Industrial regulations<br>• Green energy incentives<br>• Public transport expansion<br>• Tree plantation drives<br><br>🌍 Many countries following WHO air quality guidelines';
            }
            
            // === LONG-TERM EFFECTS ===
            if (msg.includes('long term') || msg.includes('chronic')) {
                return '⏰ <strong>Long-term Health Effects:</strong><br><br>⚠️ Prolonged exposure causes:<br>• Chronic respiratory diseases<br>• Heart disease<br>• Stroke<br>• Lung cancer<br>• Reduced life expectancy (avg. 2-5 years)<br>• Cognitive decline<br>• Developmental issues in children<br><br>☠️ Air pollution kills 7 million people/year globally';
            }
            
            // === TECHNOLOGY ===
            if (msg.includes('monitor') || msg.includes('sensor') || msg.includes('measure')) {
                return '📡 <strong>AQI Monitoring:</strong><br><br>🔬 <strong>Methods:</strong><br>1. Government monitoring stations<br>2. Low-cost sensors (PurpleAir, etc.)<br>3. Satellite data<br>4. Mobile apps<br><br>📊 This app uses OpenWeatherMap API for real-time data from official stations worldwide!';
            }
            
            // === SPECIFIC SCENARIOS ===
            if (msg.includes('open window') || msg.includes('ventilation')) {
                return '🪟 <strong>When to Open Windows:</strong><br><br>✅ <strong>Open when:</strong> AQI < 100<br>🚫 <strong>Keep closed:</strong> AQI > 100<br><br>💡 <strong>Best Times:</strong><br>• Early morning (6-8 AM)<br>• After rain<br>• Windy days<br><br>Cross-ventilation best for air circulation!';
            }
            
            if (msg.includes('sleep') || msg.includes('bedroom')) {
                return '😴 <strong>Sleep & Air Quality:</strong><br><br>Good air = Better sleep!<br><br>💤 <strong>Bedroom Tips:</strong><br>1. Keep AQI < 50 if possible<br>2. Use air purifier at night<br>3. No smoking/incense<br>4. Clean bedding weekly<br>5. Humidity 40-50%<br>6. Open windows if AQI good<br><br>🛌 Poor air = Snoring, sleep apnea, fatigue';
            }
            
            // === DEFAULT RESPONSES ===
            if (msg.includes('thank') || msg.includes('thanks') || msg.includes('shukriya') || msg.includes('dhanyavaad')) {
                if (isUrduHindi) {
                    return '😊 Koi baat nahi! Safe raho aur saaf hawa mein saans lo! Aur sawal bhi pooch sakte ho. 🌍';
                }
                return '😊 You\'re welcome! Stay safe and breathe clean air! Feel free to ask more questions. 🌍';
            }
            
            if (msg.includes('hello') || msg.includes('hi') || msg.includes('hey') || 
                msg.includes('assalam') || msg.includes('namaste') || msg.includes('salam')) {
                if (isUrduHindi) {
                    return '👋 Assalam-o-Alaikum / Namaste! Main aapka AQI assistant hoon. Mujh se air quality, pollution, health effects, ya protection ke bare mein kuch bhi pooch sakte ho! Try karo: "PM2.5 kya hai?" ya "Exercise karna safe hai kya?"';
                }
                return '👋 Hello! I\'m your AQI assistant. Ask me anything about air quality, pollution, health effects, or protection tips! Try: "What is PM2.5?" or "Is it safe to exercise?"';
            }
            
            // === CATCH-ALL ===
            if (isUrduHindi) {
                return `🤔 Main samajh gaya aap "<strong>${message}</strong>" ke bare mein pooch rahe hain.<br><br>Main in topics mein help kar sakta hoon:<br>• 📊 AQI basics & calculations<br>• 🌫️ Pollutants (PM2.5, PM10, CO, NO2, SO2, O3)<br>• 🏥 Health effects & protection<br>• 🏃 Exercise & outdoor activities<br>• 🏠 Indoor air quality<br>• 👶 Bachche, buzurg, pregnancy<br>• 🌍 Cities ki specific info<br>• ❄️ Seasonal changes<br><br>Try karo: "PM2.5 kya hai?" ya "High AQI mein health tips"`;
            }
            return `🤔 I understand you're asking about "<strong>${message}</strong>".<br><br>I can help with:<br>• 📊 AQI basics & calculations<br>• 🌫️ Pollutants (PM2.5, PM10, CO, NO2, SO2, O3)<br>• 🏥 Health effects & protection<br>• 🏃 Exercise & outdoor activities<br>• 🏠 Indoor air quality<br>• 👶 Children, elderly, pregnancy<br>• 🌍 City-specific info<br>• ❄️ Seasonal changes<br><br>Try asking: "What is PM2.5?" or "Health tips for high AQI"`;
        }

        function quickChat(question) {
            document.getElementById('chatInput').value = question;
            sendChatMessage();
        }

        // MOBILE APP
        function showMobileApp() {
            playSound(900, 150);
            document.getElementById('mobileAppModal').style.display = 'block';
        }

        function closeMobileAppModal() {
            document.getElementById('mobileAppModal').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['healthModal', 'notificationsModal', 'languageModal', 'mapModal', 'chatbotModal', 'mobileAppModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Handle Enter key in chat
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        });

        // ========== END NEW FEATURES ==========

        // Store chart instance globally to destroy before recreating
        let mainAqiChart = null;

        {% if aqi_data %}
        // Chart.js for AQI forecast
        {% if chart_data %}
        
        // Destroy existing chart if it exists
        if (mainAqiChart) {
            mainAqiChart.destroy();
            mainAqiChart = null;
        }
        
        const ctx = document.getElementById('aqiChart').getContext('2d');
        const chartData = {{ chart_data|tojson }};
        
        if (chartData && chartData.labels && chartData.values) {
            mainAqiChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'AQI Forecast',
                    data: chartData.values,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: '#764ba2',
                    pointHoverBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            font: {
                                family: 'Poppins',
                                size: 14,
                                weight: '600'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(102, 126, 234, 0.9)',
                        titleFont: {
                            family: 'Poppins',
                            size: 14,
                            weight: '600'
                        },
                        bodyFont: {
                            family: 'Poppins',
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                family: 'Poppins',
                                size: 12
                            }
                        }
                    }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                family: 'Poppins',
                                size: 11
                            },
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            });
        } else {
            console.error('Chart data is invalid or missing');
        }
        {% else %}
        console.log('No chart data available');
        {% endif %}
        {% endif %}

        // Location Auto-Detect Function
        async function useMyLocation() {
            console.log('🚀 useMyLocation() function called!');
            console.log('📍 Starting location detection...');
            
            if (!navigator.geolocation) {
                console.log('❌ Geolocation NOT supported');
                alert('❌ Geolocation is not supported by your browser');
                return;
            }
            
            console.log('✅ Geolocation IS supported');
            playSound(900, 150);
            
            // Show loading message
            const loadingMsg = document.createElement('div');
            loadingMsg.innerHTML = '<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(102,126,234,0.95);color:white;padding:30px;border-radius:15px;z-index:10000;font-size:18px;box-shadow:0 10px 40px rgba(0,0,0,0.3);">🌍 Detecting your location...<br>Please wait...</div>';
            document.body.appendChild(loadingMsg);
            
            navigator.geolocation.getCurrentPosition(async (position) => {
                console.log('✅✅✅ LOCATION RECEIVED! ✅✅✅');
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                console.log(`📍 Your coordinates: ${lat}, ${lon} (Accuracy: ${accuracy}m)`);
                console.log('🌐 Now fetching location details from Nominatim...');
                
                // ACCURACY CHECK - agar GPS accuracy kam hai to warning show karo
                if (accuracy > 1000) {
                    console.warn(`⚠️ LOW GPS ACCURACY: ${accuracy}m - Location may be approximate`);
                }
                
                try {
                    // Get AQI data directly using coordinates
                    const apiKey = 'fe4feefa8543e06d4f3c66d92c61b69c';
                    
                    // Get MAXIMUM PRECISION location info with zoom=18 (better for cities)
                    // zoom=18 gives city-level detail without being too specific
                    console.log('🔄 Calling Nominatim API...');
                    const geoResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1&extratags=1&namedetails=1`, {
                        headers: {
                            'Accept-Language': 'en,ur,pk', // Request English, Urdu, and Pakistan languages
                            'User-Agent': 'AQI-Tracker-App/1.0'
                        }
                    });
                    console.log('✅ Nominatim API response received');
                    const geoData = await geoResponse.json();
                    console.log('✅ JSON parsed successfully');
                    
                    console.log('🗺️ Location Details:', geoData);
                    
                    // Extract ULTRA-DETAILED location information
                    const address = geoData.address || {};
                    const locationParts = [];
                    
                    // Build MAXIMUM DETAIL location string - showing exact area within city
                    
                    // 1. MOST SPECIFIC: Building/POI/Landmark name
                    if (geoData.name && geoData.name !== geoData.display_name) {
                        locationParts.push(`🏢 ${geoData.name}`);
                    }
                    
                    // 2. House/Shop number + Road/Street name (CRITICAL for exact location)
                    const streetDetails = [];
                    if (address.house_number) streetDetails.push(address.house_number);
                    if (address.road || address.street) streetDetails.push(address.road || address.street);
                    if (streetDetails.length > 0) {
                        locationParts.push(`🛣️ ${streetDetails.join(' ')}`);
                    }
                    
                    // 3. NEIGHBORHOOD/AREA/LOCALITY (MOST IMPORTANT - this shows Ghari Pul, Khaki Shahpul, etc.)
                    const areaName = address.neighbourhood || 
                                    address.suburb || 
                                    address.quarter || 
                                    address.hamlet || 
                                    address.residential ||
                                    address.industrial ||
                                    address.commercial ||
                                    address.locality ||
                                    address.sublocality ||
                                    address.village;
                    
                    if (areaName) {
                        locationParts.push(`📍 <strong style="font-size:18px;color:#ffeb3b;">${areaName}</strong>`);
                    }
                    
                    // 4. City/Town - IMPROVED PAKISTAN DETECTION + PARSE FROM DISPLAY_NAME
                    // Try multiple sources in priority order
                    let cityName = address.city || address.town || address.municipality;
                    
                    // PAKISTAN SPECIAL: County is usually the district name
                    // But we need to check if it's actually the city we're in
                    if (!cityName && address.county) {
                        cityName = address.county;
                        // Remove "District" suffix if present
                        cityName = cityName.replace(/\s+District$/i, '').trim();
                    }
                    
                    // If county gave us "Larkana" but we need "Khairpur", try city_district
                    if (!cityName && address.city_district) {
                        cityName = address.city_district;
                        cityName = cityName.replace(/\s+District$/i, '').trim();
                    }
                    
                    // CRITICAL FIX: Check if neighbourhood/suburb is actually the city name
                    // For Khairpur region, neighbourhood might be more accurate than county
                    if (areaName && !cityName) {
                        // If area name looks like a city (not just a small locality)
                        cityName = areaName;
                    }
                    
                    // FALLBACK: Parse display_name intelligently
                    if (!cityName && geoData.display_name) {
                        const parts = geoData.display_name.split(',').map(p => p.trim());
                        // Try to find the actual city name (usually 2nd or 3rd element)
                        for (let i = 1; i < Math.min(parts.length, 4); i++) {
                            const part = parts[i];
                            // Skip if it contains administrative terms
                            if (part && !part.match(/Taluka|Tehsil|Division|Tehsil|District$/i)) {
                                // Check if this might be Khairpur
                                if (part.toLowerCase().includes('khair')) {
                                    cityName = 'Khairpur';
                                    break;
                                }
                                if (!cityName) {
                                    cityName = part.replace(/\s+District$/i, '').trim();
                                }
                            }
                        }
                    }
                    
                    // Last resort: state_district
                    if (!cityName && address.state_district) {
                        cityName = address.state_district;
                        cityName = cityName.replace(/\s+District$/i, '').trim();
                    }
                    
                    // SMART CORRECTION: If coordinates are closer to Khairpur than Larkana
                    // Khairpur coordinates: approximately 27.53, 68.76
                    // Larkana coordinates: approximately 27.56, 68.21
                    const khairpurLat = 27.53, khairpurLon = 68.76;
                    const larkanaLat = 27.56, larkanaLon = 68.21;
                    
                    const distToKhairpur = Math.sqrt(Math.pow(lat - khairpurLat, 2) + Math.pow(lon - khairpurLon, 2));
                    const distToLarkana = Math.sqrt(Math.pow(lat - larkanaLat, 2) + Math.pow(lon - larkanaLon, 2));
                    
                    // If we're closer to Khairpur but got Larkana, correct it
                    if (distToKhairpur < distToLarkana && cityName && cityName.toLowerCase().includes('larkana')) {
                        console.log(`🔄 CORRECTION: Coordinates closer to Khairpur (${distToKhairpur.toFixed(4)}) than Larkana (${distToLarkana.toFixed(4)})`);
                        cityName = 'Khairpur';
                    }
                    
                    // Add city
                    if (cityName) {
                        locationParts.push(`🏙️ ${cityName}`);
                    }
                    
                    // 5. District (if different from city)
                    if (address.state_district && address.state_district !== cityName) {
                        locationParts.push(`🗺️ ${address.state_district}`);
                    }
                    
                    // 6. Province/State
                    if (address.state) {
                        locationParts.push(`🏛️ ${address.state}`);
                    }
                    
                    // 7. Country
                    if (address.country) {
                        locationParts.push(`🌍 ${address.country}`);
                    }
                    
                    const detailedLocation = locationParts.length > 0 ? locationParts.join(', ') : geoData.display_name;
                    
                    // For search, use CLEANED city name (remove "District" for better API results)
                    // Priority: actual city name > parsed from display_name > county
                    let searchCity = cityName || address.county || 'Your Location';
                    searchCity = searchCity.replace(/\s+District$/i, '').trim();
                    
                    // LOG ALL LOCATION DATA FOR DEBUGGING (ULTRA-DETAILED)
                    console.log('═══════════════════════════════════════');
                    console.log('📌 ULTRA-DETAILED LOCATION BREAKDOWN:');
                    console.log('═══════════════════════════════════════');
                    console.log('🌐 FULL DISPLAY NAME:', geoData.display_name);
                    console.log('═══════════════════════════════════════');
                    console.log('� POI/Building Name:', geoData.name || 'N/A');
                    console.log('�🏠 House Number:', address.house_number || 'N/A');
                    console.log('🛣️  Road/Street:', address.road || address.street || 'N/A');
                    console.log('📍 Neighbourhood:', address.neighbourhood || 'N/A');
                    console.log('🏘️  Suburb:', address.suburb || 'N/A');
                    console.log('🏘️  Locality:', address.locality || 'N/A');
                    console.log('🏘️  Sublocality:', address.sublocality || 'N/A');
                    console.log('🗺️  Quarter:', address.quarter || 'N/A');
                    console.log('🏘️  Hamlet:', address.hamlet || 'N/A');
                    console.log('�️  Village:', address.village || 'N/A');
                    console.log('�🏙️  City:', address.city || 'N/A');
                    console.log('🏙️  Town:', address.town || 'N/A');
                    console.log('🏙️  Municipality:', address.municipality || 'N/A');
                    console.log('🏛️  City District:', address.city_district || 'N/A');
                    console.log('📍 County:', address.county || 'N/A');
                    console.log('🗺️  State District:', address.state_district || 'N/A');
                    console.log('🏛️  State/Province:', address.state || 'N/A');
                    console.log('🌍 Country:', address.country || 'N/A');
                    console.log('═══════════════════════════════════════');
                    console.log('✅ Detected Area Name:', areaName || 'N/A');
                    console.log('✅ Final City Name:', cityName);
                    console.log('✅ Complete Location:', detailedLocation);
                    console.log('✅ Will Search For:', searchCity);
                    console.log('═══════════════════════════════════════');
                    console.log('📊 Full API Response:', geoData);
                    console.log('═══════════════════════════════════════');
                    
                    // Now get AQI data using coordinates (more reliable than city name)
                    const aqiResponse = await fetch(`http://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${apiKey}`);
                    const aqiData = await aqiResponse.json();
                    
                    if (aqiData && aqiData.list && aqiData.list.length > 0) {
                        const components = aqiData.list[0].components;
                        const aqi = aqiData.list[0].main.aqi;
                        
                        // Calculate US EPA AQI from PM2.5
                        const pm25 = components.pm2_5;
                        let usAqi = 0;
                        if (pm25 <= 12) usAqi = (50/12) * pm25;
                        else if (pm25 <= 35.4) usAqi = 50 + ((100-50)/(35.4-12.1)) * (pm25-12.1);
                        else if (pm25 <= 55.4) usAqi = 100 + ((150-100)/(55.4-35.5)) * (pm25-35.5);
                        else if (pm25 <= 150.4) usAqi = 150 + ((200-150)/(150.4-55.5)) * (pm25-55.5);
                        else if (pm25 <= 250.4) usAqi = 200 + ((300-200)/(250.4-150.5)) * (pm25-150.5);
                        else usAqi = 300 + ((500-300)/(500.4-250.5)) * (pm25-250.5);
                        
                        usAqi = Math.round(usAqi);
                        
                        // Remove loading message
                        document.body.removeChild(loadingMsg);
                        
                        // Show VERY DETAILED location with area/neighborhood prominently
                        const locationInfo = document.createElement('div');
                        
                        // Build detailed location breakdown
                        let locationHTML = '<div style="background:rgba(255,255,255,0.15);padding:12px;border-radius:10px;margin-bottom:12px;">';
                        
                        // Show exact area/neighborhood if available (MOST IMPORTANT)
                        if (areaName) {
                            locationHTML += `<div style="font-size:20px;margin-bottom:8px;color:#ffeb3b;">📍 <strong>${areaName}</strong></div>`;
                        }
                        
                        // Show road/street if available
                        if (address.road) {
                            locationHTML += `<div style="font-size:14px;margin-bottom:5px;">🛣️ <strong>Road:</strong> ${address.road}</div>`;
                        }
                        
                        // Show city
                        if (cityName) {
                            locationHTML += `<div style="font-size:14px;margin-bottom:5px;">🏙️ <strong>City:</strong> ${cityName}</div>`;
                        }
                        
                        // Show district if different from city
                        if (address.state_district && address.state_district !== cityName) {
                            locationHTML += `<div style="font-size:14px;margin-bottom:5px;">🗺️ <strong>District:</strong> ${address.state_district}</div>`;
                        }
                        
                        // Show province/state
                        if (address.state) {
                            locationHTML += `<div style="font-size:14px;">🏛️ <strong>Province:</strong> ${address.state}</div>`;
                        }
                        
                        locationHTML += '</div>';
                        
                        locationInfo.innerHTML = `
                            <div style="position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px 30px;border-radius:15px;z-index:10000;box-shadow:0 10px 40px rgba(0,0,0,0.3);max-width:480px;animation:slideIn 0.5s ease;">
                                <div style="font-size:24px;margin-bottom:15px;text-align:center;border-bottom:2px solid rgba(255,255,255,0.3);padding-bottom:10px;">📍 Your Exact Location</div>
                                ${locationHTML}
                                <div style="font-size:13px;opacity:0.9;margin-top:10px;background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;">
                                    <div style="margin-bottom:5px;">🎯 <strong>GPS:</strong> ${lat.toFixed(6)}°, ${lon.toFixed(6)}°</div>
                                    <div style="margin-bottom:5px;">📏 <strong>Accuracy:</strong> ±${Math.round(accuracy)} meters</div>
                                    <div style="margin-bottom:5px;">💨 <strong>Current AQI:</strong> ${usAqi}</div>
                                </div>
                                <div style="font-size:12px;opacity:0.8;margin-top:10px;padding:8px;background:rgba(255,255,255,0.1);border-radius:6px;text-align:center;">
                                    🔍 Searching AQI data for: <strong>${searchCity}</strong>
                                </div>
                                <button onclick="this.parentElement.parentElement.remove()" style="margin-top:15px;background:white;color:#667eea;border:none;padding:12px 25px;border-radius:8px;cursor:pointer;font-weight:bold;width:100%;font-size:15px;transition:all 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">✅ Got it! Show Results →</button>
                            </div>
                            <style>
                                @keyframes slideIn {
                                    from { transform: translateX(500px); opacity: 0; }
                                    to { transform: translateX(0); opacity: 1; }
                                }
                            </style>
                        `;
                        document.body.appendChild(locationInfo);
                        
                        // Fill the input field with DETECTED CITY NAME for search
                        document.getElementById('cityInput').value = searchCity;
                        
                        // Submit the form to show results
                        playSound(1200, 200);
                        document.querySelector('form').submit();
                        
                    } else {
                        document.body.removeChild(loadingMsg);
                        alert('❌ Could not fetch AQI data for your location');
                    }
                } catch (error) {
                    console.error('❌❌❌ ERROR IN LOCATION DETECTION ❌❌❌');
                    console.error('Error details:', error);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    document.body.removeChild(loadingMsg);
                    alert('❌ Error detecting location: ' + error.message);
                }
            }, (error) => {
                console.error('❌❌❌ GEOLOCATION ERROR ❌❌❌');
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                if (document.body.contains(loadingMsg)) {
                    document.body.removeChild(loadingMsg);
                }
                alert('❌ Error getting location: ' + error.message + '\n\nPlease make sure location permissions are enabled in your browser.');
            });
        }

        // ========== DARK MODE TOGGLE ==========
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.querySelector('.theme-toggle').textContent = isDark ? '☀️' : '🌙';
        }
        // Load saved theme (wait for DOM to be ready)
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                const toggleBtn = document.querySelector('.theme-toggle');
                if (toggleBtn) toggleBtn.textContent = '☀️';
            }
        });

        // ========== FAVORITES SYSTEM (ENHANCED) ==========
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        
        // Add from input field
        function addFavoriteFromInput() {
            const input = document.getElementById('favorite-input');
            const city = input.value.trim();
            
            if (!city) {
                alert('⚠️ Please enter a city name!');
                return;
            }
            
            if (favorites.includes(city)) {
                alert(`⚠️ ${city} is already in your favorites!`);
                input.value = '';
                return;
            }
            
            favorites.push(city);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateFavoritesDisplay();
            playSound('add');
            
            // Show success message
            input.value = '';
            input.placeholder = `✅ ${city} added! Add another...`;
            setTimeout(() => {
                input.placeholder = 'Type city name to add to favorites...';
            }, 2000);
        }
        
        // Add from search results (existing function)
        function addToFavorites(city) {
            if (!favorites.includes(city)) {
                favorites.push(city);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                updateFavoritesDisplay();
                playSound('add');
                alert(`⭐ ${city} added to favorites!`);
            } else {
                alert(`⚠️ ${city} is already in favorites!`);
            }
        }
        
        // Remove favorite
        function removeFavorite(city) {
            if (confirm(`Remove ${city} from favorites?`)) {
                favorites = favorites.filter(f => f !== city);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                updateFavoritesDisplay();
                
                // Show notification
                const input = document.getElementById('favorite-input');
                if (input) {
                    input.placeholder = `🗑️ ${city} removed!`;
                    setTimeout(() => {
                        input.placeholder = 'Type city name (e.g., London, Paris, Tokyo)...';
                    }, 2000);
                }
            }
        }
        
        // Clear all favorites
        function clearAllFavorites() {
            if (favorites.length === 0) {
                alert('📭 No favorites to clear!');
                return;
            }
            
            if (confirm(`Clear all ${favorites.length} favorite cities?\n\nThis cannot be undone.`)) {
                favorites = [];
                localStorage.removeItem('favorites');
                updateFavoritesDisplay();
                
                const input = document.getElementById('favorite-input');
                if (input) {
                    input.placeholder = '🗑️ All favorites cleared!';
                    setTimeout(() => {
                        input.placeholder = 'Type city name (e.g., London, Paris, Tokyo)...';
                    }, 2000);
                }
            }
        }
        
        // Update the favorites display
        function updateFavoritesDisplay() {
            const listDiv = document.getElementById('favorites-list');
            if (!listDiv) {
                console.error('Favorites list not found!');
                return;
            }
            
            if (favorites.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; font-style: italic;">No favorites yet. Add cities above!</p>';
            } else {
                listDiv.innerHTML = '';
                favorites.forEach(city => {
                    const chip = document.createElement('span');
                    chip.className = 'favorite-chip';
                    chip.innerHTML = `${city} <span class="remove" onclick="removeFavorite('${city}'); event.stopPropagation();">✕</span>`;
                    chip.onclick = (e) => { 
                        if (!e.target.classList.contains('remove')) {
                            searchCity(city); 
                        }
                    };
                    chip.title = `Click to search ${city}, or click ✕ to remove`;
                    listDiv.appendChild(chip);
                });
            }
        }
        
        // Legacy function for compatibility
        function updateFavoritesBar() {
            updateFavoritesDisplay();
        }
        
        function searchCity(city) {
            const input = document.getElementById('cityInput');
            const form = document.getElementById('aqi-form');
            if (input && form) {
                input.value = city;
                form.submit();
            } else {
                console.error('Form elements not found!');
            }
        }
        
        // Initialize favorites display when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateFavoritesDisplay();
        });

        // ========== SOCIAL SHARING ==========
        function shareToTwitter(city, aqi, country) {
            const location = country && country !== 'Unknown' ? `${city}, ${country}` : city;
            const text = `The Air Quality Index (AQI) in ${location} is ${aqi}. Check yours! 🌍`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.href)}`, '_blank');
        }
        function shareToWhatsApp(city, aqi, country) {
            const location = country && country !== 'Unknown' ? `${city}, ${country}` : city;
            const text = `The Air Quality Index (AQI) in ${location} is ${aqi}. Check yours! 🌍 ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }
        function shareToFacebook(city, aqi, country) {
            const location = country && country !== 'Unknown' ? `${city}, ${country}` : city;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(`AQI in ${location} is ${aqi}`)}`, '_blank');
        }

        // ========== SOUND EFFECTS ==========
        function playSound(type) {
            const sounds = {
                'add': new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuEzvLZiTYIHmm98OSeUQ0OUq3l8LheHAU7k9nyz3kyBSl+zPDdi0AKEmC465+gUA0MTKXh8r5vIgYsi8/y2oU2BR9rvfTlnFIOD1Sv5fS4Xh0GOpTZ88x4Mg'),
                'search': new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuEzvLZiTYIHmm98OSeUQ0OUq3l8LheHAU7k9nyz3kyBSl+zPDdi0AKEmC465+gUA0MTKXh8r5vIgYsi8/y2oU2BR9rvfTlnFIOD1Sv5fS4Xh0GOpTZ88x4Mg')
            };
            if (sounds[type]) sounds[type].play().catch(() => {});
        }

        // ========== AUTO-COMPLETE CITY SUGGESTIONS (WORLDWIDE - 500+ Cities) ==========
        const cities = [
            // Pakistan Cities (Complete List - All Major & Medium Cities)
            "Karachi", "Lahore", "Islamabad", "Rawalpindi", "Faisalabad", "Multan", "Peshawar", "Quetta", "Sialkot", "Gujranwala",
            "Hyderabad", "Sukkur", "Larkana", "Khairpur", "Mirpur Khas", "Nawabshah", "Shikarpur", "Jacobabad", "Kandhkot", "Ghotki",
            "Sargodha", "Bahawalpur", "Jhang", "Sheikhupura", "Rahim Yar Khan", "Gujrat", "Sahiwal", "Kasur", "Okara", "Jhelum",
            "Mardan", "Mingora", "Abbottabad", "Mansehra", "Haripur", "Kohat", "Bannu", "Dera Ismail Khan", "Swat", "Chitral",
            "Dera Ghazi Khan", "Muzaffargarh", "Layyah", "Rajanpur", "Mianwali", "Khushab", "Bhakkar", "Attock", "Chakwal", "Wah Cantonment",
            "Narowal", "Hafizabad", "Mandi Bahauddin", "Chiniot", "Toba Tek Singh", "Vehari", "Khanewal", "Lodhran", "Pakpattan",
            "Turbat", "Gwadar", "Khuzdar", "Chaman", "Ziarat", "Pishin", "Zhob", "Sibi", "Nasirabad", "Jaffarabad",
            "Gilgit", "Skardu", "Hunza", "Ghanche", "Chilas", "Astore", "Diamer", "Muzaffarabad", "Mirpur", "Kotli", "Rawalakot",
            
            // India Cities (All Major Cities - Complete Coverage)
            "Delhi", "New Delhi", "Mumbai", "Bangalore", "Bengaluru", "Hyderabad", "Chennai", "Kolkata", "Pune", "Ahmedabad", 
            "Jaipur", "Lucknow", "Kanpur", "Nagpur", "Indore", "Bhopal", "Patna", "Chandigarh", "Ludhiana", "Agra", "Varanasi", "Srinagar",
            "Gurgaon", "Noida", "Ghaziabad", "Faridabad", "Meerut", "Aligarh", "Moradabad", "Saharanpur", "Bareilly", "Dehradun",
            "Amritsar", "Jalandhar", "Patiala", "Bathinda", "Mohali", "Pathankot", "Hoshiarpur", "Kota", "Jodhpur", "Udaipur", "Ajmer", "Bikaner",
            "Vadodara", "Surat", "Rajkot", "Bhavnagar", "Jamnagar", "Gandhinagar", "Anand", "Mehsana", "Nashik", "Aurangabad", "Nagpur", "Thane", "Navi Mumbai",
            "Visakhapatnam", "Vijayawada", "Guntur", "Nellore", "Tirupati", "Kakinada", "Warangal", "Nizamabad", "Coimbatore", "Madurai", "Tiruchirappalli", "Salem", "Tirunelveli", "Erode", "Vellore",
            "Kochi", "Thiruvananthapuram", "Kozhikode", "Thrissur", "Kollam", "Kannur", "Alappuzha", "Palakkad",
            "Guwahati", "Shillong", "Imphal", "Agartala", "Aizawl", "Kohima", "Itanagar", "Gangtok", "Bhubaneswar", "Cuttack", "Rourkela", "Puri",
            "Ranchi", "Jamshedpur", "Dhanbad", "Bokaro", "Raipur", "Bilaspur", "Durg", "Bhilai", "Gwalior", "Jabalpur", "Ujjain", "Sagar",
            
            // Middle East (Complete)
            "Dubai", "Abu Dhabi", "Sharjah", "Ajman", "Ras Al Khaimah", "Fujairah", "Al Ain", "Riyadh", "Jeddah", "Mecca", "Medina", "Dammam", "Khobar", "Dhahran",
            "Doha", "Al Rayyan", "Al Wakrah", "Kuwait City", "Muscat", "Salalah", "Sohar", "Manama", "Riffa", "Muharraq",
            "Amman", "Zarqa", "Irbid", "Aqaba", "Beirut", "Tripoli", "Sidon", "Damascus", "Aleppo", "Homs", "Latakia", "Baghdad", "Basra", "Mosul", "Erbil", "Kirkuk", "Sulaymaniyah",
            "Tehran", "Mashhad", "Isfahan", "Shiraz", "Tabriz", "Karaj", "Qom", "Ahvaz", "Jerusalem", "Tel Aviv", "Haifa", "Beersheba", "Netanya", "Ramallah", "Gaza",
            
            // Europe (Major Cities - All Countries)
            "London", "Manchester", "Birmingham", "Liverpool", "Leeds", "Edinburgh", "Glasgow", "Dublin", "Cork", "Belfast",
            "Paris", "Marseille", "Lyon", "Toulouse", "Nice", "Nantes", "Strasbourg", "Bordeaux", "Lille", "Rennes",
            "Berlin", "Munich", "Hamburg", "Frankfurt", "Cologne", "Stuttgart", "Dortmund", "Essen", "Dresden", "Leipzig",
            "Madrid", "Barcelona", "Valencia", "Seville", "Zaragoza", "Málaga", "Bilbao", "Alicante", "Córdoba", "Granada",
            "Rome", "Milan", "Naples", "Turin", "Palermo", "Genoa", "Bologna", "Florence", "Venice", "Verona",
            "Amsterdam", "Rotterdam", "The Hague", "Utrecht", "Eindhoven", "Groningen", "Brussels", "Antwerp", "Ghent", "Bruges",
            "Vienna", "Graz", "Linz", "Salzburg", "Innsbruck", "Prague", "Brno", "Ostrava", "Warsaw", "Kraków", "Wrocław", "Poznań", "Gdańsk",
            "Budapest", "Debrecen", "Szeged", "Athens", "Thessaloniki", "Patras", "Lisbon", "Porto", "Braga",
            "Stockholm", "Gothenburg", "Malmö", "Copenhagen", "Aarhus", "Odense", "Oslo", "Bergen", "Trondheim", "Helsinki", "Espoo", "Tampere",
            "Zurich", "Geneva", "Basel", "Bern", "Lausanne", "Lucerne", "Bucharest", "Sofia", "Belgrade", "Zagreb", "Ljubljana",
            
            // North America (USA & Canada - Complete)
            "New York", "Los Angeles", "Chicago", "Houston", "Phoenix", "Philadelphia", "San Antonio", "San Diego", "Dallas", "San Jose",
            "Austin", "Jacksonville", "Fort Worth", "Columbus", "Charlotte", "San Francisco", "Indianapolis", "Seattle", "Denver", "Washington DC",
            "Boston", "El Paso", "Nashville", "Detroit", "Oklahoma City", "Portland", "Las Vegas", "Memphis", "Louisville", "Baltimore",
            "Milwaukee", "Albuquerque", "Tucson", "Fresno", "Sacramento", "Mesa", "Kansas City", "Atlanta", "Miami", "Tampa", "Orlando",
            "Toronto", "Montreal", "Vancouver", "Calgary", "Edmonton", "Ottawa", "Winnipeg", "Quebec City", "Hamilton", "Mississauga",
            
            // South America (Complete)
            "São Paulo", "Rio de Janeiro", "Brasília", "Salvador", "Fortaleza", "Belo Horizonte", "Curitiba", "Manaus", "Recife", "Porto Alegre",
            "Buenos Aires", "Córdoba", "Rosario", "Mendoza", "La Plata", "Lima", "Arequipa", "Trujillo", "Chiclayo", "Bogotá", "Medellín", "Cali", "Barranquilla", "Cartagena",
            "Santiago", "Valparaíso", "Concepción", "Caracas", "Maracaibo", "Valencia", "Montevideo", "Quito", "Guayaquil", "La Paz", "Santa Cruz", "Asunción",
            
            // East Asia (Complete - China, Japan, Korea)
            "Tokyo", "Yokohama", "Osaka", "Nagoya", "Sapporo", "Fukuoka", "Kobe", "Kyoto", "Kawasaki", "Hiroshima", "Sendai",
            "Beijing", "Shanghai", "Guangzhou", "Shenzhen", "Chengdu", "Tianjin", "Wuhan", "Chongqing", "Nanjing", "Xi'an", "Hangzhou", "Suzhou", "Dongguan", "Qingdao", "Dalian", "Zhengzhou",
            "Hong Kong", "Macau", "Taipei", "Kaohsiung", "Taichung", "Tainan", "Seoul", "Busan", "Incheon", "Daegu", "Daejeon", "Gwangju", "Suwon", "Ulsan",
            
            // Southeast Asia (Complete)
            "Singapore", "Bangkok", "Chiang Mai", "Pattaya", "Phuket", "Manila", "Quezon City", "Davao", "Cebu", "Jakarta", "Surabaya", "Bandung", "Medan", "Semarang", "Makassar",
            "Kuala Lumpur", "Penang", "Johor Bahru", "Ipoh", "Hanoi", "Ho Chi Minh City", "Da Nang", "Yangon", "Mandalay", "Phnom Penh", "Vientiane", "Bandar Seri Begawan", "Denpasar",
            
            // Australia & Oceania (Complete)
            "Sydney", "Melbourne", "Brisbane", "Perth", "Adelaide", "Gold Coast", "Canberra", "Newcastle", "Wollongong", "Hobart",
            "Auckland", "Wellington", "Christchurch", "Hamilton", "Tauranga", "Dunedin", "Port Moresby", "Suva", "Nuku'alofa", "Apia",
            
            // Africa (Major Cities - All Regions)
            "Cairo", "Alexandria", "Giza", "Lagos", "Kano", "Ibadan", "Abuja", "Johannesburg", "Cape Town", "Durban", "Pretoria", "Port Elizabeth",
            "Nairobi", "Mombasa", "Nakuru", "Casablanca", "Rabat", "Fez", "Marrakech", "Tangier", "Algiers", "Oran", "Constantine", "Tunis", "Sfax",
            "Addis Ababa", "Dire Dawa", "Dar es Salaam", "Dodoma", "Mwanza", "Accra", "Kumasi", "Kampala", "Entebbe", "Khartoum", "Omdurman",
            "Dakar", "Abidjan", "Kinshasa", "Lubumbashi", "Luanda", "Maputo", "Harare", "Lusaka", "Antananarivo", "Windhoek", "Gaborone",
            
            // Central Asia & Others
            "Tashkent", "Samarkand", "Bukhara", "Almaty", "Nur-Sultan", "Shymkent", "Bishkek", "Osh", "Dushanbe", "Ashgabat", "Kabul", "Kandahar", "Herat", "Mazar-i-Sharif",
            "Baku", "Yerevan", "Tbilisi", "Ulaanbaatar", "Kathmandu", "Pokhara", "Dhaka", "Chittagong", "Colombo", "Kandy", "Jaffna", "Thimphu", "Malé"
        ];

        const cityInput = document.getElementById('cityInput');
        const suggestionsDiv = document.getElementById('suggestions');

        // IMPROVED: Real-time auto-complete (CASE-INSENSITIVE + Match Anywhere)
        cityInput.addEventListener('input', function() {
            const query = this.value.trim().toLowerCase();
            
            if (query.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            // Filter cities: MATCH ANYWHERE in city name (not just start)
            const matches = cities.filter(city => 
                city.toLowerCase().includes(query) // CHANGED: includes instead of startsWith
            ).sort((a, b) => {
                // Sort: Cities starting with query first, then alphabetically
                const aStarts = a.toLowerCase().startsWith(query);
                const bStarts = b.toLowerCase().startsWith(query);
                if (aStarts && !bStarts) return -1;
                if (!aStarts && bStarts) return 1;
                return a.localeCompare(b);
            }).slice(0, 10); // Show max 10 suggestions

            if (matches.length === 0) {
                // Show "No matches" message
                suggestionsDiv.innerHTML = `
                    <div style="padding: 15px; text-align: center; color: #ff6b6b; font-weight: 600;">
                        ⚠️ No cities found matching "${this.value}"
                        <br><small style="color: #666; font-weight: 400;">Try: Delhi, Karachi, London, Dubai, etc.</small>
                    </div>
                `;
                suggestionsDiv.style.display = 'block';
                return;
            }

            // Show suggestions with HIGHLIGHTED matching text
            suggestionsDiv.innerHTML = matches.map(city => {
                // Highlight the matching part
                const regex = new RegExp(`(${query})`, 'gi');
                const highlightedCity = city.replace(regex, '<span style="background:#ffeb3b;color:#000;font-weight:700;padding:1px 3px;border-radius:3px;">$1</span>');
                
                return `
                    <div class="suggestion-item" style="
                        padding: 12px 20px;
                        cursor: pointer;
                        border-bottom: 1px solid #f0f0f0;
                        transition: all 0.2s ease;
                        font-weight: 500;
                        color: #333;
                    " onmouseover="this.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; this.style.color='white';" 
                       onmouseout="this.style.background='white'; this.style.color='#333';"
                       onclick="selectCity('${city}')">
                        📍 ${highlightedCity}
                    </div>
                `;
            }).join('');
            
            suggestionsDiv.style.display = 'block';
        });

        // Select city from suggestions
        function selectCity(city) {
            cityInput.value = city;
            suggestionsDiv.style.display = 'none';
            cityInput.focus();
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target !== cityInput && e.target !== suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
        });

        // Prevent form submission if no exact match (optional - remove if you want to allow any input)
        document.getElementById('aqi-form').addEventListener('submit', function(e) {
            const inputValue = cityInput.value.trim();
            const exactMatch = cities.some(city => 
                city.toLowerCase() === inputValue.toLowerCase()
            );
            
            if (!exactMatch) {
                e.preventDefault();
                suggestionsDiv.innerHTML = `
                    <div style="padding: 15px; text-align: center; color: #ff6b6b; font-weight: 600;">
                        ❌ "${inputValue}" is not in our database!
                        <br><small style="color: #666; font-weight: 400; margin-top: 8px; display: block;">
                        Please select from suggestions or try: Delhi, London, Tokyo, Dubai, etc.
                        </small>
                    </div>
                `;
                suggestionsDiv.style.display = 'block';
                cityInput.focus();
                cityInput.select();
                return false;
            }
        });
    </script>
</body>
```
</html>
